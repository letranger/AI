<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-12-05 Tue 13:37 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>監督式學習</title>
<meta name="author" content="Yung-Chin Yen" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../css/muse.css" />
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">監督式學習</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org5307fc4">1. 簡介</a>
<ul>
<li><a href="#orge51f146">1.1. 監督式學習的主要類型</a></li>
<li><a href="#orgcb62662">1.2. 範例</a></li>
<li><a href="#org5b8a76e">1.3. 特例</a></li>
</ul>
</li>
<li><a href="#org9572875">2. 監督式學習基本步驟</a></li>
<li><a href="#org4adf568">3. 監督式學習演算法</a>
<ul>
<li><a href="#orge36609d">3.1. K-nearest neighbors (KNN)</a></li>
<li><a href="#org77e5c6e">3.2. Methods based on tree(Decision tree and Random Forest)</a></li>
<li><a href="#orgbafa815">3.3. Boosting</a></li>
<li><a href="#orgb385b6c">3.4. SVM(Support Vector Machines)</a></li>
<li><a href="#orge7828ef">3.5. 神經網路</a></li>
</ul>
</li>
<li><a href="#org0a6da2e">4. 監督式學習實作</a></li>
<li><a href="#orgae00d4e">5. 推薦系統: 受限波爾茲曼機 on MovieLens</a>
<ul>
<li><a href="#orge7ec504">5.1. 資料準備</a></li>
<li><a href="#orgf3f6e66">5.2. 定義loss function</a></li>
<li><a href="#orgabf1b67">5.3. 矩陣分解</a></li>
<li><a href="#org6f586a1">5.4. 使用RBMs的協同過濾</a></li>
<li><a href="#orga383890">5.5. RBM神經網路架構</a></li>
<li><a href="#orgd7a1d9f">5.6. 重建RBM元件</a></li>
<li><a href="#org370493c">5.7. 訓練</a></li>
</ul>
</li>
<li><a href="#orgd891176">6. 深度信念網路(DBNs)</a>
<ul>
<li><a href="#org10cf684">6.1. MNIST分類</a></li>
<li><a href="#orga7e4182">6.2. Restricted Boltzmann Machines (RBMs)</a></li>
<li><a href="#org91a7e72">6.3. 為DBN訓練三個RBMs</a></li>
<li><a href="#orgd9bd022">6.4. 查看RBM誤差</a></li>
<li><a href="#org3db1beb">6.5. 檢視特徵偵測器</a></li>
<li><a href="#org007a827">6.6. 查看RBM生成的影像</a></li>
<li><a href="#org92ca7cf">6.7. 完整的DBN</a></li>
<li><a href="#orgad9d0dc">6.8. 訓練DBN</a></li>
<li><a href="#orgeda09d7">6.9. 看錯誤</a></li>
<li><a href="#org1b3bb5b">6.10. 生成影像以建構更好的影像分類器</a></li>
<li><a href="#orgfe47adb">6.11. 使用DBN來產生新的影像10次</a></li>
<li><a href="#org33def2d">6.12. 使用LightGBM建構影像分類器</a></li>
</ul>
</li>
</ul>
</div>
</div>
<a href="https://letranger.github.io/AI/20221023101626-監督式學習.html"><img align="right" alt="Hits" src="https://hits.sh/letranger.github.io/AI/20221023101626-監督式學習.html.svg"/></a>
<div id="outline-container-org5307fc4" class="outline-2">
<h2 id="org5307fc4"><span class="section-number-2">1.</span> 簡介</h2>
<div class="outline-text-2" id="text-1">
<p>
監督式學習獲得的結果可以是數值、也可以是類別，以結果分類，我們可以將監督式學分大致分為兩類：<a href="20221023154410-regression.html#ID-6ae7fb7a-0b38-4448-b19f-073d262513f2">迴歸</a>(結果為數值)與<a href="20231204210821-分類.html#ID-1592687a-cca7-4473-83a0-682a36394a28">分類</a>(結果為類別)。
</p>
</div>
<div id="outline-container-orge51f146" class="outline-3">
<h3 id="orge51f146"><span class="section-number-3">1.1.</span> 監督式學習的主要類型</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org78bd130" class="outline-4">
<h4 id="org78bd130"><span class="section-number-4">1.1.1.</span> 分類(Cliasification)</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
分類問題也稱為離散(discrete)預測問題，因為每個分類都是一個離散群組。In supervised learning, the training set you feed to the algorithm includes the desired solutions, called labels<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>.
</p>


<div id="org17521eb" class="figure">
<p><img src="images/2022-04-30_10-38-58.jpg" alt="2022-04-30_10-38-58.jpg" width="500" />
</p>
<p><span class="figure-number">Figure 1: </span>典型的監督式學習：垃圾郵件分類</p>
</div>

<p>
可再細分為:
</p>
<ul class="org-ul">
<li>Binary classification</li>
<li>Multiclass classification</li>
</ul>

<p>
典型的分類案例: MNIST, IRIS
</p>
</div>
</div>
<div id="outline-container-org8d2f878" class="outline-4">
<h4 id="org8d2f878"><span class="section-number-4">1.1.2.</span> 迴歸(Regression)</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
另一種監督式學習為<a href="20221023154410-regression.html#ID-6ae7fb7a-0b38-4448-b19f-073d262513f2">迴歸</a>（regression），即，根據一組預測特徵（predictor，如里程數、車齡、品牌）來預測目標數值（如二手車車價）<sup><a id="fnr.1.100" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>，這個目標數值也是label。
</p>

<p>
有些迴歸演算法也可以用來分類，例如Logistic，它可以輸出一個數值，以這個數值來表示對應到特定類別的機率，例如，某封email為垃圾郵件的機率為20%、某張圖片為狗的機率為70%。
</p>

<p>
迴歸問題可再細分為兩類：
</p>
<ul class="org-ul">
<li>Linear regression:
<ul class="org-ul">
<li>假設輸入變量(x)與單一輸出變量(y)間存在線性關係，並以此建立模型。</li>
<li>優點: 簡單、容易解釋</li>
<li>缺點: 輸入與輸出變量關係為線性時會導致低度擬合</li>
<li>例: 身高與體重間的關係</li>
</ul></li>
<li>Logistic regression
<ul class="org-ul">
<li>也是線性方法，但使用logist function轉換輸出的預測結果，其輸出結果為類別機率(class probabilities)</li>
<li>優點: 簡單、容易解釋</li>
<li>缺點: 輸入與輸出變量關係為線性時無法處理分類問題</li>
</ul></li>
</ul>

<p>
典型迴歸案例: Boston Housing Data
</p>
</div>
</div>
</div>
<div id="outline-container-orgcb62662" class="outline-3">
<h3 id="orgcb62662"><span class="section-number-3">1.2.</span> 範例</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org88e1a50" class="outline-4">
<h4 id="org88e1a50"><span class="section-number-4">1.2.1.</span> 信用卡詐欺</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
以信用卡公司來說，信用卡詐欺可以透過各種資料對照評分，預測出該事件的分數。例如地點：一個平時生活在台灣的用戶忽然在日本刷卡、或一個平時都是白天刷卡消費的用戶忽然在凌晨三點刷卡，這些事件都可以當成評分指標(特徵)，提供模型做為預測是否為信用卡詐欺的預測依據。
</p>
</div>
</div>
<div id="outline-container-orgd83b197" class="outline-4">
<h4 id="orgd83b197"><span class="section-number-4">1.2.2.</span> 影像辨識</h4>
</div>
</div>
<div id="outline-container-org5b8a76e" class="outline-3">
<h3 id="org5b8a76e"><span class="section-number-3">1.3.</span> 特例</h3>
<div class="outline-text-3" id="text-1-3">
<p>
<a href="20221023101626-監督式學習.html#ID-20221023T101626.420918">監督式學習</a>主要包括<a href="20231204210821-分類.html#ID-1592687a-cca7-4473-83a0-682a36394a28">分類</a>和<a href="20221023154410-regression.html#ID-6ae7fb7a-0b38-4448-b19f-073d262513f2">迴歸</a>，但也包括以下奇特的例子：
</p>
<ul class="org-ul">
<li>序列生成(sequence generation)：給定一張圖，產生一個標題來描述該圖片，有時也可以使用一部份連續的資料進行預測。</li>
<li>語法樹預測(syntax tree prediction)：給定一個句子，以語意的結構為節點，預測並分解成語法樹。</li>
<li>物體偵測(object detection)：給定一張圖片，繪製邊界框來標示圖片內不同的物體。這也可以視為分類問題（給定許多候選邊界框，對每個邊界框的內容進行分類）或并用分類和迴歸技巧，透過向量迴歸預測邊界框。</li>
<li>圖像分割(image segmentation)：給定一張圖片，用像素遮罩(pixel-level mask)來區別不同物體。</li>
<li>Linear Regression: 拿前幾天的空氣 PM 值預估未來的空氣 PM 值</li>
<li>Classification
<ol class="org-ol">
<li>Binary Classification: 垃圾郵件分類</li>
<li>Multi-class Classification: 手語翻譯</li>
<li>k-Nearest Neighbors (KNN)</li>
<li>Naive Bayes Classifiers</li>
<li>Decision Tree</li>
<li>Neural Networks (Deep Learning)</li>
<li>Ensembles of Decision Trees</li>
<li>Linear Models: Logistic regression</li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9572875" class="outline-2">
<h2 id="org9572875"><span class="section-number-2">2.</span> 監督式學習基本步驟</h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li>準備學習對象的資料</li>
<li>將資料分為輸入資料（特徵）與輸出資料（標籤、即該組特徵的答案）</li>
<li>將特徵輸入類神經網路</li>
<li>將類神經網路的預測結果與標籤進行比較、計算二者間的差異</li>
<li>將4.的差異回饋給模型、依此更新模型中的參數</li>
<li>回到3.</li>
</ol>
</div>
</div>
<div id="outline-container-org4adf568" class="outline-2">
<h2 id="org4adf568"><span class="section-number-2">3.</span> 監督式學習演算法</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orge36609d" class="outline-3">
<h3 id="orge36609d"><span class="section-number-3">3.1.</span> K-nearest neighbors (KNN)</h3>
<div class="outline-text-3" id="text-3-1">
<p>
KNN藉由找出與新資料點最相近的 <i>k</i> 個已具有label的資料點，讓這些資料點投票決定新資料點的label。
</p>
<ul class="org-ul">
<li>優點: 能處理更複雜的非線性關係，但仍可被解釋</li>
<li>缺點: 隨著資料與features的數量增加，KNN的效果也會降低； <i>k</i> 值的選擇也會影響KNN的效果，太小的 <i>k</i> 值會導致過度擬合、太高的 <i>k</i> 值則會低度擬合。</li>
<li>應用: 經常用於推薦系統</li>
</ul>
</div>
</div>
<div id="outline-container-org77e5c6e" class="outline-3">
<h3 id="org77e5c6e"><span class="section-number-3">3.2.</span> Methods based on tree(Decision tree and Random Forest)</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Single decision tree: 遍歷所有訓練資枓來建立規則，但容易過度擬合</li>
<li>Bagging: 將上述tree加入bootstrap aggregation(如bagging)，即，使用多次隨機實例採樣(multiple random samples of instances)，並為每次採樣建立一棵decision tree，並對每個資料實例進行預測，預測方式為透過平均每棵樹的預測結果，藉由這種方式可以解決decision tree容易過度擬合的問題。</li>
<li>Random forest: 除了將資料實例進行採樣，也對每棵decision tree的分支條件中 <b>待預測label</b> 進行隨機採樣，而非使用所有的待預測label。透過這種方式，random forest可以建立出彼此相關性更低的decision，進而改善過度擬合與泛化誤差。</li>
</ul>
</div>
</div>
<div id="outline-container-orgbafa815" class="outline-3">
<h3 id="orgbafa815"><span class="section-number-3">3.3.</span> Boosting</h3>
<div class="outline-text-3" id="text-3-3">
<p>
同樣是建立許多樹，但是它 <b>依多建立每棵decision tree</b> , 利用前一棵decision所習得的資訊來改善下一棵decision tree的預測結果。是所有tree-based solution中表現最好的方式，也是許多machine learning比賽的常勝軍。
</p>
<ul class="org-ul">
<li>優點：performance佳，能處理資料缺失與特徵分類問題</li>
<li>缺點：可解釋性低</li>
</ul>
</div>
</div>
<div id="outline-container-orgb385b6c" class="outline-3">
<h3 id="orgb385b6c"><span class="section-number-3">3.4.</span> SVM(Support Vector Machines)</h3>
<div class="outline-text-3" id="text-3-4">
<p>
使用演算法和已知的label在空間中建構超平面來分類資料
</p>
</div>
</div>
<div id="outline-container-orge7828ef" class="outline-3">
<h3 id="orge7828ef"><span class="section-number-3">3.5.</span> 神經網路</h3>
</div>
</div>
<div id="outline-container-org0a6da2e" class="outline-2">
<h2 id="org0a6da2e"><span class="section-number-2">4.</span> 監督式學習實作</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li><a href="20231204210821-分類.html#ID-1592687a-cca7-4473-83a0-682a36394a28">分類</a></li>
<li><a href="20221023154410-regression.html#ID-6ae7fb7a-0b38-4448-b19f-073d262513f2">迴歸</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgae00d4e" class="outline-2">
<h2 id="orgae00d4e"><span class="section-number-2">5.</span> 推薦系統: 受限波爾茲曼機 on MovieLens</h2>
<div class="outline-text-2" id="text-5">
<p>
MovieLens 是一個推薦系統和虛擬社區網站，於1997年建立。其主要功能為應用協同過濾技術和用戶對電影的喜好，向用戶推薦電影。該網站是GroupLens研究所旗下一個項目，該研究所隸屬於美國明尼蘇達大學雙城分校計算機科學與工程系。MovieLens 20M資料集包含20,000,263筆關於27,278部電影的評價，評價者共138,493人。
</p>
</div>
<div id="outline-container-orge7ec504" class="outline-3">
<h3 id="orge7ec504"><span class="section-number-3">5.1.</span> 資料準備</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org4478cc4" class="outline-4">
<h4 id="org4478cc4"><span class="section-number-4">5.1.1.</span> Setup</h4>
<div class="outline-text-4" id="text-5-1-1">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #83898d;">'''Main'''</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span class="linenr"> 3: </span><span style="color: #51afef;">import</span> pandas <span style="color: #51afef;">as</span> pd
<span class="linenr"> 4: </span><span style="color: #51afef;">import</span> os, time, re
<span class="linenr"> 5: </span><span style="color: #51afef;">import</span> pickle, gzip, datetime
<span class="linenr"> 6: </span><span style="color: #51afef;">from</span> datetime <span style="color: #51afef;">import</span> datetime
<span class="linenr"> 7: </span><span style="color: #51afef;">from</span> zipfile <span style="color: #51afef;">import</span> ZipFile
<span class="linenr"> 8: </span><span style="color: #51afef;">from</span> urllib.request <span style="color: #51afef;">import</span> urlretrieve
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #98be65;">'''Data Viz'''</span>
<span class="linenr">11: </span><span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span class="linenr">12: </span><span style="color: #51afef;">import</span> seaborn <span style="color: #51afef;">as</span> sns
<span class="linenr">13: </span><span style="color: #dcaeea;">color</span> = sns.color_palette()
<span class="linenr">14: </span><span style="color: #51afef;">import</span> matplotlib <span style="color: #51afef;">as</span> mpl
<span class="linenr">15: </span>
<span class="linenr">16: </span><span style="color: #98be65;">'''Data Prep and Model Evaluation'''</span>
<span class="linenr">17: </span><span style="color: #51afef;">from</span> sklearn <span style="color: #51afef;">import</span> preprocessing <span style="color: #51afef;">as</span> pp
<span class="linenr">18: </span><span style="color: #51afef;">from</span> sklearn.model_selection <span style="color: #51afef;">import</span> train_test_split
<span class="linenr">19: </span><span style="color: #51afef;">from</span> sklearn.model_selection <span style="color: #51afef;">import</span> StratifiedKFold
<span class="linenr">20: </span><span style="color: #51afef;">from</span> sklearn.metrics <span style="color: #51afef;">import</span> log_loss
<span class="linenr">21: </span><span style="color: #51afef;">from</span> sklearn.metrics <span style="color: #51afef;">import</span> precision_recall_curve, average_precision_score
<span class="linenr">22: </span><span style="color: #51afef;">from</span> sklearn.metrics <span style="color: #51afef;">import</span> roc_curve, auc, roc_auc_score, mean_squared_error
<span class="linenr">23: </span>
<span class="linenr">24: </span><span style="color: #98be65;">'''Algos'''</span>
<span class="linenr">25: </span><span style="color: #5B6268;">#</span><span style="color: #5B6268;">import lightgbm as lgb</span>
<span class="linenr">26: </span>
<span class="linenr">27: </span><span style="color: #98be65;">'''TensorFlow and Keras'''</span>
<span class="linenr">28: </span><span style="color: #51afef;">import</span> tensorflow <span style="color: #51afef;">as</span> tf
<span class="linenr">29: </span><span style="color: #51afef;">from</span> tensorflow <span style="color: #51afef;">import</span> keras
<span class="linenr">30: </span><span style="color: #dcaeea;">K</span> = keras.backend
<span class="linenr">31: </span>
<span class="linenr">32: </span><span style="color: #51afef;">from</span> tensorflow.keras.models <span style="color: #51afef;">import</span> Sequential, Model
<span class="linenr">33: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Activation, Dense, Dropout
<span class="linenr">34: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> BatchNormalization, Input, Lambda
<span class="linenr">35: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Embedding, Flatten, dot
<span class="linenr">36: </span><span style="color: #51afef;">from</span> tensorflow.keras <span style="color: #51afef;">import</span> regularizers
<span class="linenr">37: </span><span style="color: #51afef;">from</span> tensorflow.keras.losses <span style="color: #51afef;">import</span> mse, binary_crossentropy
</pre>
</div>
</div>
</div>
<div id="outline-container-org6dae34d" class="outline-4">
<h4 id="org6dae34d"><span class="section-number-4">5.1.2.</span> Check library version</h4>
<div class="outline-text-4" id="text-5-1-2">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #51afef;">import</span> sys, sklearn
<span class="linenr">2: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'sklearn    </span>{sklearn.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">3: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'tensorflow </span>{tf.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">4: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'keras      </span>{keras.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">5: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'numpy      </span>{np.__version__}<span style="color: #98be65;">'</span>)
</pre>
</div>

<pre class="example">
sklearn    1.0.1
tensorflow 2.7.0
keras      2.7.0
numpy      1.19.5
</pre>
</div>
</div>
<div id="outline-container-org45aa5ba" class="outline-4">
<h4 id="org45aa5ba"><span class="section-number-4">5.1.3.</span> Download and unzip the Data</h4>
<div class="outline-text-4" id="text-5-1-3">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Download and read into Pandas DataFrame</span>
<span class="linenr">2: </span><span style="color: #5B6268;">#</span><span style="color: #5B6268;">import os</span>
<span class="linenr">3: </span><span style="color: #5B6268;">#</span><span style="color: #5B6268;">from urllib.request import urlretrieve</span>
<span class="linenr">4: </span><span style="color: #dcaeea;">current_path</span> = os.getcwd()
<span class="linenr">5: </span>urlretrieve(<span style="color: #98be65;">"http://files.grouplens.org/datasets/movielens/ml-20m.zip"</span>, \
<span class="linenr">6: </span>            current_path+<span style="color: #98be65;">"/dataset/movielens.zip"</span>)
<span class="linenr">7: </span>ZipFile(current_path+<span style="color: #98be65;">"/dataset/movielens.zip"</span>, <span style="color: #98be65;">"r"</span>).extractall(current_path+<span style="color: #98be65;">"/dataset/"</span>)
<span class="linenr">8: </span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org14218be" class="outline-4">
<h4 id="org14218be"><span class="section-number-4">5.1.4.</span> Load data</h4>
<div class="outline-text-4" id="text-5-1-4">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #dcaeea;">ratingDF</span> = pd.read_csv(<span style="color: #98be65;">"./dataset/ml-20m/ratings.csv"</span>)
<span class="linenr">2: </span><span style="color: #c678dd;">print</span>(ratingDF)
</pre>
</div>

<pre class="example" id="org99fd122">
          userId  movieId  rating   timestamp
0              1        2     3.5  1112486027
1              1       29     3.5  1112484676
2              1       32     3.5  1112484819
3              1       47     3.5  1112484727
4              1       50     3.5  1112484580
...          ...      ...     ...         ...
20000258  138493    68954     4.5  1258126920
20000259  138493    69526     4.5  1259865108
20000260  138493    69644     3.0  1260209457
20000261  138493    70286     5.0  1258126944
20000262  138493    71619     2.5  1255811136

[20000263 rows x 4 columns]
</pre>
</div>
</div>
<div id="outline-container-orgc7ae562" class="outline-4">
<h4 id="orgc7ae562"><span class="section-number-4">5.1.5.</span> 轉換資料</h4>
<div class="outline-text-4" id="text-5-1-5">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Convert fields into appropriate data types</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">from</span> datetime <span style="color: #51afef;">import</span> datetime
<span class="linenr"> 3: </span><span style="color: #51afef;">import</span> pandas <span style="color: #51afef;">as</span> pd
<span class="linenr"> 4: </span><span style="color: #dcaeea;">ratingDF</span> = pd.read_csv(<span style="color: #98be65;">"./dataset/ml-20m/ratings.csv"</span>)
<span class="linenr"> 5: </span>ratingDF.<span style="color: #dcaeea;">userId</span> = ratingDF.userId.astype(<span style="color: #c678dd;">str</span>).astype(<span style="color: #c678dd;">int</span>)
<span class="linenr"> 6: </span>ratingDF.<span style="color: #dcaeea;">movieId</span> = ratingDF.movieId.astype(<span style="color: #c678dd;">str</span>).astype(<span style="color: #c678dd;">int</span>)
<span class="linenr"> 7: </span>ratingDF.<span style="color: #dcaeea;">rating</span> = ratingDF.rating.astype(<span style="color: #c678dd;">str</span>).astype(<span style="color: #c678dd;">float</span>)
<span class="linenr"> 8: </span>ratingDF.<span style="color: #dcaeea;">timestamp</span> = ratingDF.timestamp.<span style="color: #c678dd;">apply</span>(<span style="color: #51afef;">lambda</span> x: \
<span class="linenr"> 9: </span>                        datetime.utcfromtimestamp(x).strftime(<span style="color: #98be65;">'%Y-%m-%d %H:%M:%S'</span>))
<span class="linenr">10: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Store DataFrame as pickle for faster loading in the future</span>
<span class="linenr">11: </span>ratingDF.to_pickle(<span style="color: #98be65;">"./dataset/ml-20m/ratingPickle"</span>)
<span class="linenr">12: </span><span style="color: #dcaeea;">ratingDF</span> = pd.read_pickle(<span style="color: #98be65;">"./dataset/ml-20m/ratingPickle"</span>)
<span class="linenr">13: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Preview data</span>
<span class="linenr">14: </span><span style="color: #c678dd;">print</span>(ratingDF.head())
</pre>
</div>

<pre class="example">
   userId  movieId  rating            timestamp
0       1        2     3.5  2005-04-02 23:53:47
1       1       29     3.5  2005-04-02 23:31:16
2       1       32     3.5  2005-04-02 23:33:39
3       1       47     3.5  2005-04-02 23:32:07
4       1       50     3.5  2005-04-02 23:29:40
</pre>
</div>
</div>
<div id="outline-container-org1ef040e" class="outline-4">
<h4 id="org1ef040e"><span class="section-number-4">5.1.6.</span> 確認使用者、評價數量</h4>
<div class="outline-text-4" id="text-5-1-6">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Calculate summary statistics on full dataset</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">n_users</span> = ratingDF.userId.unique().shape[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr"> 3: </span><span style="color: #dcaeea;">n_movies</span> = ratingDF.movieId.unique().shape[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr"> 4: </span><span style="color: #dcaeea;">n_ratings</span> = <span style="color: #c678dd;">len</span>(ratingDF)
<span class="linenr"> 5: </span><span style="color: #dcaeea;">avg_ratings_per_user</span> = n_ratings/n_users
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Number of unique users: </span>{n_users}<span style="color: #98be65;">'</span>)
<span class="linenr"> 8: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Number of unique movies: </span>{n_movies}<span style="color: #98be65;">'</span>)
<span class="linenr"> 9: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Number of total ratings: </span>{n_ratings}<span style="color: #98be65;">'</span>)
<span class="linenr">10: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Average number of ratings per user: </span>{<span style="color: #c678dd;">round</span>(avg_ratings_per_user,1)}<span style="color: #98be65;">'</span>)
</pre>
</div>

<pre class="example">
Number of unique users: 138493
Number of unique movies: 26744
Number of total ratings: 20000263
Average number of ratings per user: 144.4
</pre>
</div>
</div>
<div id="outline-container-org984e7c2" class="outline-4">
<h4 id="org984e7c2"><span class="section-number-4">5.1.7.</span> 只取前1000筆記錄</h4>
<div class="outline-text-4" id="text-5-1-7">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Reduce size of dataset by taking top 1000 movies</span>
<span class="linenr">2: </span><span style="color: #dcaeea;">movieIndex</span> = ratingDF.groupby(<span style="color: #98be65;">"movieId"</span>).count().sort_values(by=
<span class="linenr">3: </span>                <span style="color: #98be65;">"rating"</span>,ascending=<span style="color: #a9a1e1;">False</span>)[<span style="color: #da8548; font-weight: bold;">0</span>:<span style="color: #da8548; font-weight: bold;">1000</span>].index
<span class="linenr">4: </span><span style="color: #dcaeea;">ratingDFX2</span> = ratingDF[ratingDF.movieId.isin(movieIndex)]
<span class="linenr">5: </span><span style="color: #c678dd;">print</span>(ratingDFX2.count())
</pre>
</div>

<pre class="example">
userId       12840344
movieId      12840344
rating       12840344
timestamp    12840344
dtype: int64
</pre>



<p>
隨機抽1000位使用者，以這1000位使用者來過濾資料集，如此可以將庫筆數由12840344縮至90213
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Reduce size of dataset by sampling 1000 users</span>
<span class="linenr">2: </span><span style="color: #dcaeea;">userIndex</span> = ratingDFX2.groupby(<span style="color: #98be65;">"userId"</span>).count().sort_values(by=
<span class="linenr">3: </span>    <span style="color: #98be65;">"rating"</span>,ascending=<span style="color: #a9a1e1;">False</span>).sample(n=<span style="color: #da8548; font-weight: bold;">1000</span>, random_state=<span style="color: #da8548; font-weight: bold;">2018</span>).index
<span class="linenr">4: </span><span style="color: #dcaeea;">ratingDFX3</span> = ratingDFX2[ratingDFX2.userId.isin(userIndex)]
<span class="linenr">5: </span><span style="color: #c678dd;">print</span>(ratingDFX3.count())
</pre>
</div>

<pre class="example">
userId       90213
movieId      90213
rating       90213
timestamp    90213
dtype: int64
</pre>
</div>
</div>
<div id="outline-container-org8ca15a5" class="outline-4">
<h4 id="org8ca15a5"><span class="section-number-4">5.1.8.</span> 針對已縮減的資料集重建index(movieID, userID)</h4>
<div class="outline-text-4" id="text-5-1-8">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Reindex movie ID</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">movies</span> = ratingDFX3.movieId.unique()
<span class="linenr"> 3: </span><span style="color: #dcaeea;">moviesDF</span> = pd.DataFrame(data=movies,columns=[<span style="color: #98be65;">'originalMovieId'</span>])
<span class="linenr"> 4: </span><span style="color: #dcaeea;">moviesDF</span>[<span style="color: #98be65;">'newMovieId'</span>] = moviesDF.index+<span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr"> 5: </span><span style="color: #c678dd;">print</span>(moviesDF.head())
<span class="linenr"> 6: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Reindex user ID</span>
<span class="linenr"> 7: </span><span style="color: #dcaeea;">users</span> = ratingDFX3.userId.unique()
<span class="linenr"> 8: </span><span style="color: #dcaeea;">usersDF</span> = pd.DataFrame(data=users,columns=[<span style="color: #98be65;">'originalUserId'</span>])
<span class="linenr"> 9: </span><span style="color: #dcaeea;">usersDF</span>[<span style="color: #98be65;">'newUserId'</span>] = usersDF.index+<span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">10: </span><span style="color: #c678dd;">print</span>(usersDF.head())
<span class="linenr">11: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Generate newly merged DataFrame</span>
<span class="linenr">12: </span><span style="color: #dcaeea;">ratingDFX3</span> = ratingDFX3.merge(moviesDF,left_on=<span style="color: #98be65;">'movieId'</span>,
<span class="linenr">13: </span>                              right_on=<span style="color: #98be65;">'originalMovieId'</span>)
<span class="linenr">14: </span>ratingDFX3.drop(labels=<span style="color: #98be65;">'originalMovieId'</span>, axis=<span style="color: #da8548; font-weight: bold;">1</span>, inplace=<span style="color: #a9a1e1;">True</span>)
<span class="linenr">15: </span><span style="color: #dcaeea;">ratingDFX3</span> = ratingDFX3.merge(usersDF,left_on=<span style="color: #98be65;">'userId'</span>,
<span class="linenr">16: </span>                              right_on=<span style="color: #98be65;">'originalUserId'</span>)
<span class="linenr">17: </span>ratingDFX3.drop(labels=<span style="color: #98be65;">'originalUserId'</span>, axis=<span style="color: #da8548; font-weight: bold;">1</span>, inplace=<span style="color: #a9a1e1;">True</span>)
<span class="linenr">18: </span><span style="color: #c678dd;">print</span>(ratingDFX3.head(<span style="color: #da8548; font-weight: bold;">3</span>))
</pre>
</div>

<pre class="example" id="orgc8c856a">
   originalMovieId  newMovieId
0               50           1
1              163           2
2              216           3
3              296           4
4              333           5
   originalUserId  newUserId
0              49          1
1             260          2
2             311          3
3             319          4
4             499          5
   userId  movieId  rating            timestamp  newMovieId  newUserId
0      49       50     5.0  2013-05-03 02:50:26           1          1
1      49      163     3.5  2013-05-03 02:43:37           2          1
2      49      216     3.0  2013-05-03 02:45:58           3          1
</pre>
</div>
</div>
<div id="outline-container-org1cb762a" class="outline-4">
<h4 id="org1cb762a"><span class="section-number-4">5.1.9.</span> 計算縮減資料庫大小</h4>
<div class="outline-text-4" id="text-5-1-9">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Calculate summary statistics on reduced dataset</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">n_users</span> = ratingDFX3.userId.unique().shape[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr"> 3: </span><span style="color: #dcaeea;">n_movies</span> = ratingDFX3.movieId.unique().shape[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr"> 4: </span><span style="color: #dcaeea;">n_ratings</span> = <span style="color: #c678dd;">len</span>(ratingDFX3)
<span class="linenr"> 5: </span><span style="color: #dcaeea;">avg_ratings_per_user</span> = n_ratings/n_users
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Number of unique users: </span>{n_users}<span style="color: #98be65;">'</span>)
<span class="linenr"> 8: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Number of unique movies: </span>{n_movies}<span style="color: #98be65;">'</span>)
<span class="linenr"> 9: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Number of total ratings: </span>{n_ratings}<span style="color: #98be65;">'</span>)
<span class="linenr">10: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Average number of ratings per user: </span>{<span style="color: #c678dd;">round</span>(avg_ratings_per_user,1)}<span style="color: #98be65;">'</span>)
</pre>
</div>

<pre class="example">
Number of unique users: 1000
Number of unique movies: 1000
Number of total ratings: 90213
Average number of ratings per user: 90.2
</pre>
</div>
</div>
<div id="outline-container-orgedf5c77" class="outline-4">
<h4 id="orgedf5c77"><span class="section-number-4">5.1.10.</span> 產生訓練集、測試集和驗證集</h4>
<div class="outline-text-4" id="text-5-1-10">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Split into validation and test, such that each is 5% of the dataset</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">X_train</span>, <span style="color: #dcaeea;">X_test</span> = train_test_split(ratingDFX3, test_size=<span style="color: #da8548; font-weight: bold;">0.10</span>, \
<span class="linenr"> 3: </span>                                   shuffle=<span style="color: #a9a1e1;">True</span>, random_state=<span style="color: #da8548; font-weight: bold;">2018</span>)
<span class="linenr"> 4: </span><span style="color: #dcaeea;">X_valid</span>, <span style="color: #dcaeea;">X_test</span> = train_test_split(X_test,     test_size=<span style="color: #da8548; font-weight: bold;">0.50</span>, \
<span class="linenr"> 5: </span>                                   shuffle=<span style="color: #a9a1e1;">True</span>, random_state=<span style="color: #da8548; font-weight: bold;">2018</span>)
<span class="linenr"> 6: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Confirm size of train, validation, and test datasets</span>
<span class="linenr"> 7: </span><span style="color: #51afef;">for</span> (l,x) <span style="color: #51afef;">in</span> [(<span style="color: #98be65;">'train'</span>,X_train),(<span style="color: #98be65;">'validation'</span>,X_valid),(<span style="color: #98be65;">'test'</span>,X_test)]:
<span class="linenr"> 8: </span>    <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Size of </span>{l}<span style="color: #98be65;"> set: </span>{<span style="color: #c678dd;">len</span>(x)}<span style="color: #98be65;">'</span>)
<span class="linenr"> 9: </span><span style="color: #c678dd;">print</span>(X_train.shape)
<span class="linenr">10: </span><span style="color: #c678dd;">print</span>(X_test.shape)
<span class="linenr">11: </span><span style="color: #c678dd;">print</span>(X_valid.shape)
</pre>
</div>

<pre class="example">
Size of train set: 81191
Size of validation set: 4511
Size of test set: 4511
(81191, 6)
(4511, 6)
(4511, 6)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf3f6e66" class="outline-3">
<h3 id="orgf3f6e66"><span class="section-number-3">5.2.</span> 定義loss function</h3>
<div class="outline-text-3" id="text-5-2">
<p>
先建一個 \(m\times n\) 的矩陣，\(m\) 為使用者、\(n\) 為電影。此為稀疏矩陣，因為一位使用者不會對所有電影評價。
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Generate ratings matrix for train, validation and test</span>
<span class="linenr">2: </span><span style="color: #dcaeea;">ratings_train</span> = np.zeros((n_users, n_movies))
<span class="linenr">3: </span><span style="color: #dcaeea;">ratings_valid</span> = np.zeros((n_users, n_movies))
<span class="linenr">4: </span><span style="color: #dcaeea;">ratings_test</span>  = np.zeros((n_users, n_movies))
<span class="linenr">5: </span><span style="color: #51afef;">for</span> (X,ratings) <span style="color: #51afef;">in</span> [(X_train,ratings_train),(X_valid,ratings_valid),(X_test,ratings_test)]:
<span class="linenr">6: </span>    <span style="color: #51afef;">for</span> row <span style="color: #51afef;">in</span> X.itertuples():
<span class="linenr">7: </span>        ratings[row[<span style="color: #da8548; font-weight: bold;">6</span>]-<span style="color: #da8548; font-weight: bold;">1</span>, row[<span style="color: #da8548; font-weight: bold;">5</span>]-<span style="color: #da8548; font-weight: bold;">1</span>] = row[<span style="color: #da8548; font-weight: bold;">3</span>]
<span class="linenr">8: </span><span style="color: #c678dd;">print</span>(ratings_train.shape, ratings_valid.shape, ratings_test.shape)
</pre>
</div>

<pre class="example">
(1000, 1000) (1000, 1000) (1000, 1000)
</pre>


<p>
使用MSE評估預測值與實際值間的均方差，故需要兩個大小為 <i>[n,1]</i> 的矩陣，一個放實際評價、一個放預估評價
</p>
</div>
<div id="outline-container-orgb3f2f2c" class="outline-4">
<h4 id="orgb3f2f2c"><span class="section-number-4">5.2.1.</span> 先將稀疏矩陣展開</h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Flatten the sprace matrix with the rations for the validation set. This will be the vector of actual ratings</span>
<span class="linenr">2: </span><span style="color: #dcaeea;">actual_valid</span> = ratings_valid[ratings_valid.nonzero()].flatten()
</pre>
</div>
</div>
</div>
<div id="outline-container-orgda486f7" class="outline-4">
<h4 id="orgda486f7"><span class="section-number-4">5.2.2.</span> 以電影平均評價(3.5)做為驗證集的評價預測，計算MSE，得到基準值1.06</h4>
<div class="outline-text-4" id="text-5-2-2">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #dcaeea;">pred_valid</span> = np.zeros((<span style="color: #c678dd;">len</span>(X_valid),<span style="color: #da8548; font-weight: bold;">1</span>))
<span class="linenr">2: </span><span style="color: #dcaeea;">pred_valid</span>[pred_valid==<span style="color: #da8548; font-weight: bold;">0</span>] = <span style="color: #da8548; font-weight: bold;">3.5</span>
<span class="linenr">3: </span><span style="color: #dcaeea;">naive_prediction</span> = mean_squared_error(pred_valid, actual_valid)
<span class="linenr">4: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Mean squared error using naive prediction: </span>{<span style="color: #c678dd;">round</span>(naive_prediction,2)}<span style="color: #98be65;">'</span>)
</pre>
</div>

<pre class="example">
Mean squared error using naive prediction: 1.06
</pre>
</div>
</div>
<div id="outline-container-org1921565" class="outline-4">
<h4 id="org1921565"><span class="section-number-4">5.2.3.</span> 以使用者對所有其他影片的平均評價來預測一部未評價的電影評價</h4>
<div class="outline-text-4" id="text-5-2-3">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #dcaeea;">ratings_valid_pred</span> = np.zeros((n_users, n_movies))
<span class="linenr">2: </span><span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr">3: </span><span style="color: #51afef;">for</span> row <span style="color: #51afef;">in</span> ratings_train:
<span class="linenr">4: </span>    ratings_valid_pred[i][ratings_valid_pred[i]==<span style="color: #da8548; font-weight: bold;">0</span>] = np.mean(row[row&gt;<span style="color: #da8548; font-weight: bold;">0</span>])
<span class="linenr">5: </span>    <span style="color: #dcaeea;">i</span> += <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">6: </span>
<span class="linenr">7: </span><span style="color: #dcaeea;">pred_valid</span> = ratings_valid_pred[ratings_valid.nonzero()].flatten()
<span class="linenr">8: </span><span style="color: #dcaeea;">user_average</span> = mean_squared_error(pred_valid, actual_valid)
<span class="linenr">9: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Mean squared error using user average: </span>{<span style="color: #c678dd;">round</span>(user_average,3)}<span style="color: #98be65;">'</span>)
</pre>
</div>

<pre class="example">
Mean squared error using user average: 0.909
</pre>


<p>
MSE改善至0.9
</p>
</div>
</div>
<div id="outline-container-orgf1f61e9" class="outline-4">
<h4 id="orgf1f61e9"><span class="section-number-4">5.2.4.</span> 以所有其他使用者對於某電影的評價來預估某使用者的評價</h4>
<div class="outline-text-4" id="text-5-2-4">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #dcaeea;">ratings_valid_pred</span> = np.zeros((n_users, n_movies)).T
<span class="linenr"> 2: </span><span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 3: </span><span style="color: #51afef;">for</span> row <span style="color: #51afef;">in</span> ratings_train.T:
<span class="linenr"> 4: </span>    ratings_valid_pred[i][ratings_valid_pred[i]==<span style="color: #da8548; font-weight: bold;">0</span>] = np.mean(row[row&gt;<span style="color: #da8548; font-weight: bold;">0</span>])
<span class="linenr"> 5: </span>    <span style="color: #dcaeea;">i</span> += <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #dcaeea;">ratings_valid_pred</span> = ratings_valid_pred.T
<span class="linenr"> 8: </span><span style="color: #dcaeea;">pred_valid</span> = ratings_valid_pred[ratings_valid.nonzero()].flatten()
<span class="linenr"> 9: </span><span style="color: #dcaeea;">movie_average</span> = mean_squared_error(pred_valid, actual_valid)
<span class="linenr">10: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Mean squared error using movie average: </span>{<span style="color: #c678dd;">round</span>(movie_average,3)}<span style="color: #98be65;">'</span>)
</pre>
</div>

<pre class="example">
Mean squared error using movie average: 0.914
</pre>
</div>
</div>
</div>
<div id="outline-container-orgabf1b67" class="outline-3">
<h3 id="orgabf1b67"><span class="section-number-3">5.3.</span> 矩陣分解</h3>
<div class="outline-text-3" id="text-5-3">
<p>
矩陣分解(Matrix Factorization)為目前最成功且最受歡迎的協同過濾演算法之一，它將使用者-物品矩陣分解成兩個較低維度矩陣的乘積，使用者與物品各自在較低維的潛在空間內被表示。
假設使用者-物品矩陣為R，有m個使用者和n個物品，矩陣分解會建立兩個低維矩陣:H和W，
</p>
<ul class="org-ul">
<li>H為「m個使用者」X「k個潛在因子」矩陣</li>
<li>W為「k個潛在因子」X「m個使用者」矩陣</li>
</ul>
<p>
潛在因子（latent factor）k的數量決定了模型的容量，k越高模型容量越大，但當k過高則易出現過擬合現象。
</p>
</div>
<div id="outline-container-orgd6e3b8e" class="outline-4">
<h4 id="orgd6e3b8e"><span class="section-number-4">5.3.1.</span> 單個潛在因子</h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
從最簡單的形式（只有一個潛在因子）開始，使用Keras進行矩陣分解
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span>plt.clf()
<span class="linenr"> 2: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> BatchNormalization, Input, Lambda
<span class="linenr"> 3: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Embedding, Flatten, dot
<span class="linenr"> 4: </span><span style="color: #dcaeea;">n_latent_factors</span> = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span style="color: #dcaeea;">user_input</span> = Input(shape=[<span style="color: #da8548; font-weight: bold;">1</span>], name=<span style="color: #98be65;">'user'</span>)
<span class="linenr"> 7: </span><span style="color: #dcaeea;">user_embedding</span> = Embedding(input_dim=n_users + <span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr"> 8: </span>                           output_dim=n_latent_factors,
<span class="linenr"> 9: </span>                           name=<span style="color: #98be65;">'user_embedding'</span>)(user_input)
<span class="linenr">10: </span><span style="color: #dcaeea;">user_vec</span> = Flatten(name=<span style="color: #98be65;">'flatten_users'</span>)(user_embedding)
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #dcaeea;">movie_input</span> = Input(shape=[<span style="color: #da8548; font-weight: bold;">1</span>], name=<span style="color: #98be65;">'movie'</span>)
<span class="linenr">13: </span><span style="color: #dcaeea;">movie_embedding</span> = Embedding(input_dim=n_movies + <span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr">14: </span>                            output_dim=n_latent_factors,
<span class="linenr">15: </span>                            name=<span style="color: #98be65;">'movie_embedding'</span>)(movie_input)
<span class="linenr">16: </span><span style="color: #dcaeea;">movie_vec</span> = Flatten(name=<span style="color: #98be65;">'flatten_movies'</span>)(movie_embedding)
<span class="linenr">17: </span>
<span class="linenr">18: </span><span style="color: #dcaeea;">product</span> = dot([movie_vec, user_vec], axes=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">19: </span><span style="color: #dcaeea;">model</span> = Model(inputs=[user_input, movie_input], outputs=product)
<span class="linenr">20: </span>model.<span style="color: #c678dd;">compile</span>(<span style="color: #98be65;">'adam'</span>, <span style="color: #98be65;">'mean_squared_error'</span>)
<span class="linenr">21: </span>
<span class="linenr">22: </span><span style="color: #dcaeea;">history</span> = model.fit(x=[X_train.newUserId, X_train.newMovieId],
<span class="linenr">23: </span>                    y=X_train.rating, epochs=<span style="color: #da8548; font-weight: bold;">100</span>,
<span class="linenr">24: </span>                    validation_data=([X_valid.newUserId, X_valid.newMovieId], X_valid.rating),
<span class="linenr">25: </span>                    verbose=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">26: </span>
<span class="linenr">27: </span>pd.Series(history.history[<span style="color: #98be65;">'val_loss'</span>][<span style="color: #da8548; font-weight: bold;">10</span>:]).plot(logy=<span style="color: #a9a1e1;">False</span>)
<span class="linenr">28: </span>plt.xlabel(<span style="color: #98be65;">"Epoch"</span>)
<span class="linenr">29: </span>plt.ylabel(<span style="color: #98be65;">"Validation Error"</span>)
<span class="linenr">30: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Minimum MSE: </span>{<span style="color: #c678dd;">round</span>(<span style="color: #c678dd;">min</span>(history.history['val_loss']),3)}<span style="color: #98be65;">"</span>)
<span class="linenr">31: </span>plt.savefig(<span style="color: #98be65;">'images/ML-1LF.png'</span>, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
</pre>
</div>

<p>
Minimum MSE: 0.796
</p>


<div id="org7416f2f" class="figure">
<p><img src="images/ML-1LF.png" alt="ML-1LF.png" width="500" />
</p>
<p><span class="figure-number">Figure 2: </span>Caption</p>
</div>
</div>
</div>
<div id="outline-container-org3051e4e" class="outline-4">
<h4 id="org3051e4e"><span class="section-number-4">5.3.2.</span> 三個潛在因子</h4>
<div class="outline-text-4" id="text-5-3-2">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span>plt.clf()
<span class="linenr"> 2: </span>plt.cla()
<span class="linenr"> 3: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> BatchNormalization, Input, Lambda
<span class="linenr"> 4: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Embedding, Flatten, dot
<span class="linenr"> 5: </span><span style="color: #dcaeea;">n_latent_factors</span> = <span style="color: #da8548; font-weight: bold;">3</span>
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #dcaeea;">user_input</span> = Input(shape=[<span style="color: #da8548; font-weight: bold;">1</span>], name=<span style="color: #98be65;">'user'</span>)
<span class="linenr"> 8: </span><span style="color: #dcaeea;">user_embedding</span> = Embedding(input_dim=n_users + <span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr"> 9: </span>                           output_dim=n_latent_factors,
<span class="linenr">10: </span>                           name=<span style="color: #98be65;">'user_embedding'</span>)(user_input)
<span class="linenr">11: </span><span style="color: #dcaeea;">user_vec</span> = Flatten(name=<span style="color: #98be65;">'flatten_users'</span>)(user_embedding)
<span class="linenr">12: </span>
<span class="linenr">13: </span><span style="color: #dcaeea;">movie_input</span> = Input(shape=[<span style="color: #da8548; font-weight: bold;">1</span>], name=<span style="color: #98be65;">'movie'</span>)
<span class="linenr">14: </span><span style="color: #dcaeea;">movie_embedding</span> = Embedding(input_dim=n_movies + <span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr">15: </span>                            output_dim=n_latent_factors,
<span class="linenr">16: </span>                            name=<span style="color: #98be65;">'movie_embedding'</span>)(movie_input)
<span class="linenr">17: </span><span style="color: #dcaeea;">movie_vec</span> = Flatten(name=<span style="color: #98be65;">'flatten_movies'</span>)(movie_embedding)
<span class="linenr">18: </span>
<span class="linenr">19: </span><span style="color: #dcaeea;">product</span> = dot([movie_vec, user_vec], axes=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">20: </span><span style="color: #dcaeea;">model</span> = Model(inputs=[user_input, movie_input], outputs=product)
<span class="linenr">21: </span>model.<span style="color: #c678dd;">compile</span>(<span style="color: #98be65;">'adam'</span>, <span style="color: #98be65;">'mean_squared_error'</span>)
<span class="linenr">22: </span>
<span class="linenr">23: </span><span style="color: #dcaeea;">history</span> = model.fit(x=[X_train.newUserId, X_train.newMovieId],
<span class="linenr">24: </span>                    y=X_train.rating, epochs=<span style="color: #da8548; font-weight: bold;">100</span>,
<span class="linenr">25: </span>                    validation_data=([X_valid.newUserId, X_valid.newMovieId], X_valid.rating),
<span class="linenr">26: </span>                    verbose=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">27: </span>
<span class="linenr">28: </span>pd.Series(history.history[<span style="color: #98be65;">'val_loss'</span>][<span style="color: #da8548; font-weight: bold;">10</span>:]).plot(logy=<span style="color: #a9a1e1;">False</span>)
<span class="linenr">29: </span>plt.xlabel(<span style="color: #98be65;">"Epoch"</span>)
<span class="linenr">30: </span>plt.ylabel(<span style="color: #98be65;">"Validation Error"</span>)
<span class="linenr">31: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"</span><span style="color: #a9a1e1;">\n\n</span><span style="color: #98be65;">Minimum MSE: </span>{<span style="color: #c678dd;">round</span>(<span style="color: #c678dd;">min</span>(history.history['val_loss']),3)}<span style="color: #98be65;">"</span>)
<span class="linenr">32: </span>plt.savefig(<span style="color: #98be65;">'images/ML-3LF.png'</span>, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
</pre>
</div>
<p>
Minimum MSE: 0.76
</p>

<div id="org2c19d27" class="figure">
<p><img src="images/ML-3LF.png" alt="ML-3LF.png" width="500" />
</p>
<p><span class="figure-number">Figure 3: </span>Caption</p>
</div>
</div>
</div>
<div id="outline-container-org5637ac7" class="outline-4">
<h4 id="org5637ac7"><span class="section-number-4">5.3.3.</span> 五個潛在因子</h4>
<div class="outline-text-4" id="text-5-3-3">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span>plt.clf()
<span class="linenr"> 2: </span>plt.cla()
<span class="linenr"> 3: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> BatchNormalization, Input, Lambda
<span class="linenr"> 4: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Embedding, Flatten, dot
<span class="linenr"> 5: </span><span style="color: #dcaeea;">n_latent_factors</span> = <span style="color: #da8548; font-weight: bold;">5</span>
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #dcaeea;">user_input</span> = Input(shape=[<span style="color: #da8548; font-weight: bold;">1</span>], name=<span style="color: #98be65;">'user'</span>)
<span class="linenr"> 8: </span><span style="color: #dcaeea;">user_embedding</span> = Embedding(input_dim=n_users + <span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr"> 9: </span>                           output_dim=n_latent_factors,
<span class="linenr">10: </span>                           name=<span style="color: #98be65;">'user_embedding'</span>)(user_input)
<span class="linenr">11: </span><span style="color: #dcaeea;">user_vec</span> = Flatten(name=<span style="color: #98be65;">'flatten_users'</span>)(user_embedding)
<span class="linenr">12: </span>
<span class="linenr">13: </span><span style="color: #dcaeea;">movie_input</span> = Input(shape=[<span style="color: #da8548; font-weight: bold;">1</span>], name=<span style="color: #98be65;">'movie'</span>)
<span class="linenr">14: </span><span style="color: #dcaeea;">movie_embedding</span> = Embedding(input_dim=n_movies + <span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr">15: </span>                            output_dim=n_latent_factors,
<span class="linenr">16: </span>                            name=<span style="color: #98be65;">'movie_embedding'</span>)(movie_input)
<span class="linenr">17: </span><span style="color: #dcaeea;">movie_vec</span> = Flatten(name=<span style="color: #98be65;">'flatten_movies'</span>)(movie_embedding)
<span class="linenr">18: </span>
<span class="linenr">19: </span><span style="color: #dcaeea;">product</span> = dot([movie_vec, user_vec], axes=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">20: </span><span style="color: #dcaeea;">model</span> = Model(inputs=[user_input, movie_input], outputs=product)
<span class="linenr">21: </span>model.<span style="color: #c678dd;">compile</span>(<span style="color: #98be65;">'adam'</span>, <span style="color: #98be65;">'mean_squared_error'</span>)
<span class="linenr">22: </span>
<span class="linenr">23: </span><span style="color: #dcaeea;">history</span> = model.fit(x=[X_train.newUserId, X_train.newMovieId],
<span class="linenr">24: </span>                    y=X_train.rating, epochs=<span style="color: #da8548; font-weight: bold;">100</span>,
<span class="linenr">25: </span>                    validation_data=([X_valid.newUserId, X_valid.newMovieId], X_valid.rating),
<span class="linenr">26: </span>                    verbose=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">27: </span>
<span class="linenr">28: </span>pd.Series(history.history[<span style="color: #98be65;">'val_loss'</span>][<span style="color: #da8548; font-weight: bold;">10</span>:]).plot(logy=<span style="color: #a9a1e1;">False</span>)
<span class="linenr">29: </span>plt.xlabel(<span style="color: #98be65;">"Epoch"</span>)
<span class="linenr">30: </span>plt.ylabel(<span style="color: #98be65;">"Validation Error"</span>)
<span class="linenr">31: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"</span><span style="color: #a9a1e1;">\n\n</span><span style="color: #98be65;">Minimum MSE: </span>{<span style="color: #c678dd;">round</span>(<span style="color: #c678dd;">min</span>(history.history['val_loss']),3)}<span style="color: #98be65;">"</span>)
<span class="linenr">32: </span>plt.savefig(<span style="color: #98be65;">'images/ML-5LF.png'</span>, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
</pre>
</div>
<p>
Minimum MSE: 0.749
</p>
<p width="500">
<img src="images/ML-5LF.png" alt="ML-5LF.png" width="500" />
在前25回合後，有明顯的過擬合現象。
</p>
</div>
</div>
</div>
<div id="outline-container-org6f586a1" class="outline-3">
<h3 id="org6f586a1"><span class="section-number-3">5.4.</span> 使用RBMs的協同過濾</h3>
<div class="outline-text-3" id="text-5-4">
<p>
受限玻爾茲曼機（RBM，Restricted Boltzmann machine）由多倫多大學的 Geoff Hinton 等人提出，它是一種可以用於降維、分類、回歸、協同過濾、特徵學習以及主題建模的算法。
</p>

<p>
RBMs有兩層：輸入/可視層(input layer/visible layer)和和隱藏層(hidden layer)，每一層的神經元會與其他層的神經元溝通，但不會與同層內的神經元有所連接，這是RBMs的限制。
</p>

<p>
RBMs的另一重要特徵是：層之間的溝通是雙向而非單向。
</p>

<p>
RBMs中的可視層神經元會與隱藏層的神經元溝通，然後隱藏層神經元會回傳資訊給可視層，如此來回數次。RBMs進行這種形式的溝通來發展生成模型，使隱藏層的輸出經過重新建構、近似於原先的輸入。
</p>

<p>
換言之，RMBs試圖建立一個生成模型，這個模型基於以下兩個相似度來協助預測使用者是否喜歡某部電影：
</p>
<ul class="org-ul">
<li>某部電影與使用者作過評價的其他電影間的相似度</li>
<li>使用者與為某部電影作過評價的其他使用者間的相似度</li>
</ul>

<p>
可視層中會有X個神經元，X為電影數量。每一個神經元有一個介於0~1的評價(經過歸一化)。可視層的神經元會與隱藏層的神經元溝通，隱藏層的神經元會試著學習資料內部的潛在特徵。
</p>

<p>
RBMs也被稱為對稱二分雙向圖，對稱是因為每個可視的節點都被連接到每個隱藏層的結點，二分是因為有兩層節點，雙向是因為資訊的交流。
</p>
</div>
</div>
<div id="outline-container-orga383890" class="outline-3">
<h3 id="orga383890"><span class="section-number-3">5.5.</span> RBM神經網路架構</h3>
<div class="outline-text-3" id="text-5-5">
<p>
參考網路教學&#x2026;.這裡寫的太抽象(這本書竟然想用文字來把它說完，太不負責任)
</p>
<ul class="org-ul">
<li>有m個使用者和n部電影，有一個$m&times; n$的矩陣</li>
<li>訓練RBM時批次傳入k個使用者與其對n部電影的評價，進行特定回合的訓練</li>
<li>每個被傳入神經網路的x代表一個使用者對n部電影的評價，可視層有n個節點</li>
<li>可以指定隱藏層的節點數量(通常會少於可視層，以便有效率的學習特徵)</li>
<li>每個輸入$v0$與其相對應的權重$w$相乘，這個權重是透過可視層到隱藏層的資訊交流而學習到的。最後加上一個隱藏層的偏差值向量\(hb\)，這個偏差值是為了確保至少有些神經元會觸發，然後將函數$W &times; v0+hb$的結果傳入一個激活函數裡。</li>
<li>接下來對這個流程的輸出結果進行採樣(稝為 <i>Gibbs</i> 採樣)，也就是從隱藏層的激活函數的輸出最終是被隨機挑選，這種隨機方式有助於強化模型的效能與強韌性。</li>
<li>在 <i>Gibbs</i> 採樣後的輸出$h0$透過神經網路以相反的方向被回傳，這個過程稱為backward pass。在backward pass中，那些在forward pass中經由 <i>Gibbs</i> 採樣後的激活函數計算結果被傳入隱藏層，並與之前相同的權重W相乘，然後再加上可視層的新偏差向量vb。</li>
</ul>
</div>
</div>
<div id="outline-container-orgd7a1d9f" class="outline-3">
<h3 id="orgd7a1d9f"><span class="section-number-3">5.6.</span> 重建RBM元件</h3>
<div class="outline-text-3" id="text-5-6">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Make code compatible with v1 of TF</span>
<span class="linenr"> 2: </span>tf.compat.v1.disable_eager_execution()
<span class="linenr"> 3: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define RBM class</span>
<span class="linenr"> 4: </span><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">RBM</span>(<span style="color: #c678dd;">object</span>):
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">__init__</span>(<span style="color: #51afef;">self</span>, input_size, output_size,
<span class="linenr"> 7: </span>                 learning_rate, epochs, batchsize):
<span class="linenr"> 8: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#23450;&#32681;&#36229;&#21443;&#25976;</span>
<span class="linenr"> 9: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_input_size</span> = input_size
<span class="linenr">10: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_output_size</span> = output_size
<span class="linenr">11: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">learning_rate</span> = learning_rate
<span class="linenr">12: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">epochs</span> = epochs
<span class="linenr">13: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">batchsize</span> = batchsize
<span class="linenr">14: </span>
<span class="linenr">15: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#21033;&#29992;&#38646;&#30697;&#38499;&#21021;&#22987;&#21270;&#27402;&#37325;&#30697;&#38499;&#33287;&#20559;&#24046;&#30697;&#38499;</span>
<span class="linenr">16: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">w</span> = np.zeros([input_size, output_size], dtype=np.float32)
<span class="linenr">17: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">hb</span> = np.zeros([output_size], dtype=np.float32)
<span class="linenr">18: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">vb</span> = np.zeros([input_size], dtype=np.float32)
<span class="linenr">19: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#27491;&#21521;&#20659;&#36958;&#20989;&#24335;&#65292;h&#28858;&#38577;&#34255;&#23652;&#65292;v&#28858;&#21487;&#35222;&#23652;</span>
<span class="linenr">20: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">prob_h_given_v</span>(<span style="color: #51afef;">self</span>, visible, w, hb):
<span class="linenr">21: </span>        <span style="color: #51afef;">return</span> tf.nn.sigmoid(tf.matmul(visible, w) + hb)
<span class="linenr">22: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#21453;&#21521;&#20659;&#36958;&#20989;&#24335;</span>
<span class="linenr">23: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">prob_v_given_h</span>(<span style="color: #51afef;">self</span>, hidden, w, vb):
<span class="linenr">24: </span>        <span style="color: #51afef;">return</span> tf.nn.sigmoid(tf.matmul(hidden, tf.transpose(w)) + vb)
<span class="linenr">25: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#25505;&#27171;&#20989;&#24335;</span>
<span class="linenr">26: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">sample_prob</span>(<span style="color: #51afef;">self</span>, probs):
<span class="linenr">27: </span>        <span style="color: #51afef;">return</span> tf.nn.relu(tf.sign(probs - tf.random.uniform(tf.shape(probs))))
<span class="linenr">28: </span>
<span class="linenr">29: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">train</span>(<span style="color: #51afef;">self</span>, X):
<span class="linenr">30: </span>        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#20197;tensorflow&#24314;&#31435;&#19977;&#20491;placeholder: &#27402;&#37325;&#30697;&#38499;&#12289;&#38577;&#34255;&#23652;&#30340;&#20559;&#24046;&#20540;&#21521;&#37327;&#12289;&#21487;&#35222;&#23652;&#30340;&#20559;&#24046;&#20540;&#21521;&#37327;</span>
<span class="linenr">31: </span>        <span style="color: #dcaeea;">_w</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size])
<span class="linenr">32: </span>        <span style="color: #dcaeea;">_hb</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #51afef;">self</span>._output_size])
<span class="linenr">33: </span>        <span style="color: #dcaeea;">_vb</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #51afef;">self</span>._input_size])
<span class="linenr">34: </span>
<span class="linenr">35: </span>        <span style="color: #dcaeea;">prv_w</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr">36: </span>        <span style="color: #dcaeea;">prv_hb</span> = np.zeros([<span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr">37: </span>        <span style="color: #dcaeea;">prv_vb</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size], dtype=np.float32)
<span class="linenr">38: </span>
<span class="linenr">39: </span>        <span style="color: #dcaeea;">cur_w</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr">40: </span>        <span style="color: #dcaeea;">cur_hb</span> = np.zeros([<span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr">41: </span>        <span style="color: #dcaeea;">cur_vb</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size], dtype=np.float32)
<span class="linenr">42: </span>        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#32102;&#21487;&#35222;&#23652;&#30340;placehold</span>
<span class="linenr">43: </span>        <span style="color: #dcaeea;">v0</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #a9a1e1;">None</span>, <span style="color: #51afef;">self</span>._input_size])
<span class="linenr">44: </span>        <span style="color: #dcaeea;">h0</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_h_given_v(v0, _w, _hb))
<span class="linenr">45: </span>        <span style="color: #dcaeea;">v1</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_v_given_h(h0, _w, _vb))
<span class="linenr">46: </span>        <span style="color: #dcaeea;">h1</span> = <span style="color: #51afef;">self</span>.prob_h_given_v(v1, _w, _hb)
<span class="linenr">47: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#23450;&#32681;&#35492;&#24046; MSE</span>
<span class="linenr">48: </span>        <span style="color: #dcaeea;">positive_grad</span> = tf.matmul(tf.transpose(v0), h0)
<span class="linenr">49: </span>        <span style="color: #dcaeea;">negative_grad</span> = tf.matmul(tf.transpose(v1), h1)
<span class="linenr">50: </span>
<span class="linenr">51: </span>        <span style="color: #dcaeea;">update_w</span> = _w + <span style="color: #51afef;">self</span>.learning_rate * \
<span class="linenr">52: </span>            (positive_grad - negative_grad) / tf.cast(tf.shape(v0)[<span style="color: #da8548; font-weight: bold;">0</span>], tf.float32)
<span class="linenr">53: </span>        <span style="color: #dcaeea;">update_vb</span> = _vb +  <span style="color: #51afef;">self</span>.learning_rate * tf.reduce_mean(v0 - v1, <span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr">54: </span>        <span style="color: #dcaeea;">update_hb</span> = _hb +  <span style="color: #51afef;">self</span>.learning_rate * tf.reduce_mean(h0 - h1, <span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr">55: </span>
<span class="linenr">56: </span>        <span style="color: #dcaeea;">err</span> = tf.reduce_mean(tf.square(v0 - v1))
<span class="linenr">57: </span>
<span class="linenr">58: </span>        <span style="color: #dcaeea;">error_list</span> = []
<span class="linenr">59: </span>        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#21021;&#22987;&#21270;TensorFlow&#24037;&#20316;&#38542;&#27573;</span>
<span class="linenr">60: </span>        <span style="color: #51afef;">with</span> tf.compat.v1.Session() <span style="color: #51afef;">as</span> sess:
<span class="linenr">61: </span>            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#25209;&#27425;&#23559;&#36039;&#26009;&#20659;&#20837;&#36914;&#34892;&#35347;&#32244;</span>
<span class="linenr">62: </span>            sess.run(tf.compat.v1.global_variables_initializer())
<span class="linenr">63: </span>
<span class="linenr">64: </span>            <span style="color: #51afef;">for</span> epoch <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #51afef;">self</span>.epochs):
<span class="linenr">65: </span>                <span style="color: #51afef;">for</span> start, end <span style="color: #51afef;">in</span> <span style="color: #c678dd;">zip</span>(<span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #c678dd;">len</span>(X), \
<span class="linenr">66: </span>                        <span style="color: #51afef;">self</span>.batchsize),<span style="color: #c678dd;">range</span>(<span style="color: #51afef;">self</span>.batchsize,<span style="color: #c678dd;">len</span>(X), \
<span class="linenr">67: </span>                                              <span style="color: #51afef;">self</span>.batchsize)):
<span class="linenr">68: </span>                    <span style="color: #dcaeea;">batch</span> = X[start:end]
<span class="linenr">69: </span>                    <span style="color: #dcaeea;">cur_w</span> = sess.run(update_w, feed_dict={v0: batch, \
<span class="linenr">70: </span>                                    _w: prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr">71: </span>                    <span style="color: #dcaeea;">cur_hb</span> = sess.run(update_hb, feed_dict={v0: batch, \
<span class="linenr">72: </span>                                    _w: prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr">73: </span>                    <span style="color: #dcaeea;">cur_vb</span> = sess.run(update_vb, feed_dict={v0: batch, \
<span class="linenr">74: </span>                                    _w: prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr">75: </span>                    <span style="color: #dcaeea;">prv_w</span> = cur_w
<span class="linenr">76: </span>                    <span style="color: #dcaeea;">prv_hb</span> = cur_hb
<span class="linenr">77: </span>                    <span style="color: #dcaeea;">prv_vb</span> = cur_vb
<span class="linenr">78: </span>                <span style="color: #dcaeea;">error</span> = sess.run(err, feed_dict={v0: X, \
<span class="linenr">79: </span>                                _w: cur_w, _vb: cur_vb, _hb: cur_hb})
<span class="linenr">80: </span>                <span style="color: #c678dd;">print</span> (<span style="color: #98be65;">'Epoch: %d'</span> % epoch,<span style="color: #98be65;">'reconstruction error: %f'</span> % error)
<span class="linenr">81: </span>                error_list.append(error)
<span class="linenr">82: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">w</span> = prv_w
<span class="linenr">83: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">hb</span> = prv_hb
<span class="linenr">84: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">vb</span> = prv_vb
<span class="linenr">85: </span>            <span style="color: #51afef;">return</span> error_list
<span class="linenr">86: </span>
<span class="linenr">87: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">rbm_output</span>(<span style="color: #51afef;">self</span>, X):
<span class="linenr">88: </span>
<span class="linenr">89: </span>        <span style="color: #dcaeea;">input_X</span> = tf.constant(X)
<span class="linenr">90: </span>        <span style="color: #dcaeea;">_w</span> = tf.constant(<span style="color: #51afef;">self</span>.w)
<span class="linenr">91: </span>        <span style="color: #dcaeea;">_hb</span> = tf.constant(<span style="color: #51afef;">self</span>.hb)
<span class="linenr">92: </span>        <span style="color: #dcaeea;">_vb</span> = tf.constant(<span style="color: #51afef;">self</span>.vb)
<span class="linenr">93: </span>        <span style="color: #dcaeea;">out</span> = tf.nn.sigmoid(tf.matmul(input_X, _w) + _hb)
<span class="linenr">94: </span>        <span style="color: #dcaeea;">hiddenGen</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_h_given_v(input_X, _w, _hb))
<span class="linenr">95: </span>        <span style="color: #dcaeea;">visibleGen</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_v_given_h(hiddenGen, _w, _vb))
<span class="linenr">96: </span>        <span style="color: #51afef;">with</span> tf.compat.v1.Session() <span style="color: #51afef;">as</span> sess:
<span class="linenr">97: </span>            sess.run(tf.compat.v1.global_variables_initializer())
<span class="linenr">98: </span>            <span style="color: #51afef;">return</span> sess.run(out), sess.run(visibleGen), sess.run(hiddenGen)
</pre>
</div>
</div>
</div>
<div id="outline-container-org370493c" class="outline-3">
<h3 id="org370493c"><span class="section-number-3">5.7.</span> 訓練</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Convert inputX into float32</span>
<span class="linenr"> 2: </span>plt.clf()
<span class="linenr"> 3: </span><span style="color: #dcaeea;">inputX</span> = ratings_train
<span class="linenr"> 4: </span><span style="color: #dcaeea;">inputX</span> = inputX.astype(np.float32)
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define the parameters of the RBMs we will train</span>
<span class="linenr"> 7: </span><span style="color: #dcaeea;">rbm</span>=RBM(<span style="color: #da8548; font-weight: bold;">1000</span>,<span style="color: #da8548; font-weight: bold;">1000</span>,<span style="color: #da8548; font-weight: bold;">1</span>,<span style="color: #da8548; font-weight: bold;">1000</span>,<span style="color: #da8548; font-weight: bold;">200</span>)
<span class="linenr"> 8: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Train RBM model</span>
<span class="linenr"> 9: </span><span style="color: #dcaeea;">err</span> = rbm.train(inputX)
<span class="linenr">10: </span><span style="color: #dcaeea;">outputX</span>, <span style="color: #dcaeea;">reconstructedX</span>, <span style="color: #dcaeea;">hiddenX</span> = rbm.rbm_output(inputX)
<span class="linenr">11: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot reconstruction errors</span>
<span class="linenr">12: </span>pd.Series(err).plot(logy=<span style="color: #a9a1e1;">False</span>)
<span class="linenr">13: </span>plt.xlabel(<span style="color: #98be65;">"Epoch"</span>)
<span class="linenr">14: </span>plt.ylabel(<span style="color: #98be65;">"Reconstruction Error"</span>);
<span class="linenr">15: </span>plt.savefig(<span style="color: #98be65;">'images/ML-RBM.png'</span>, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
<span class="linenr">16: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Predict ratings for validation set</span>
<span class="linenr">17: </span><span style="color: #dcaeea;">inputValid</span> = ratings_valid
<span class="linenr">18: </span><span style="color: #dcaeea;">inputValid</span> = inputValid.astype(np.float32)
<span class="linenr">19: </span>
<span class="linenr">20: </span><span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">reconstructedOutput_valid</span>, <span style="color: #dcaeea;">_</span> = rbm.rbm_output(inputValid)
<span class="linenr">21: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Calculate MSE on validation set</span>
<span class="linenr">22: </span><span style="color: #dcaeea;">predictionsArray</span> = reconstructedOutput_valid
<span class="linenr">23: </span><span style="color: #dcaeea;">pred_valid</span> = predictionsArray[ratings_valid.nonzero()].flatten()
<span class="linenr">24: </span><span style="color: #dcaeea;">actual_valid</span> = ratings_valid[ratings_valid.nonzero()].flatten()
<span class="linenr">25: </span>
<span class="linenr">26: </span><span style="color: #dcaeea;">rbm_prediction</span> = mean_squared_error(pred_valid, actual_valid)
<span class="linenr">27: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'Mean squared error using RBM prediction: </span>{<span style="color: #c678dd;">round</span>(rbm_prediction,2)}<span style="color: #98be65;">'</span>)
</pre>
</div>

<p>
Epoch: 0 reconstruction error: 1.106261
Epoch: 1 reconstruction error: 1.079569
Epoch: 2 reconstruction error: 1.086965
&#x2026;
Epoch: 998 reconstruction error: 1.072312
Epoch: 999 reconstruction error: 1.072114
Mean squared error using RBM prediction: 9.34
</p>

<div id="org3f51976" class="figure">
<p><img src="images/ML-RBM.png" alt="ML-RBM.png" width="500" />
</p>
<p><span class="figure-number">Figure 4: </span>Caption</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd891176" class="outline-2">
<h2 id="orgd891176"><span class="section-number-2">6.</span> 深度信念網路(DBNs)</h2>
<div class="outline-text-2" id="text-6">
<p>
DBNs在2006年由Geoffrey Hinton在多倫多大學提出。RBMs只有兩層，DBNs由多個RBMs組成，一個RBMs的隱藏層是下一個RBMs的可視層。DBNs可以用來辨識、分群圖片、聲音、文字、影片。
在DBN中，一次只有一層被訓練，從最前面緊鄰輸入層的隱藏層開始，建構第一個RBM，當第一個RBM被訓練完後，第一個RBM的隱藏層就會被當做下一個RBM的可視層，用來訓練第二個RBM的隱藏層。
</p>
</div>
<div id="outline-container-org10cf684" class="outline-3">
<h3 id="org10cf684"><span class="section-number-3">6.1.</span> MNIST分類</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-orge29e56b" class="outline-4">
<h4 id="orge29e56b"><span class="section-number-4">6.1.1.</span> 載入函式庫</h4>
<div class="outline-text-4" id="text-6-1-1">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #83898d;">'''Main'''</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span class="linenr"> 3: </span><span style="color: #51afef;">import</span> pandas <span style="color: #51afef;">as</span> pd
<span class="linenr"> 4: </span><span style="color: #51afef;">import</span> os, time, re
<span class="linenr"> 5: </span><span style="color: #51afef;">import</span> pickle, gzip, datetime
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #98be65;">'''Data Viz'''</span>
<span class="linenr"> 8: </span><span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span class="linenr"> 9: </span><span style="color: #51afef;">import</span> seaborn <span style="color: #51afef;">as</span> sns
<span class="linenr">10: </span><span style="color: #dcaeea;">color</span> = sns.color_palette()
<span class="linenr">11: </span><span style="color: #51afef;">import</span> matplotlib <span style="color: #51afef;">as</span> mpl
<span class="linenr">12: </span><span style="color: #51afef;">from</span> mpl_toolkits.axes_grid1 <span style="color: #51afef;">import</span> Grid
<span class="linenr">13: </span>
<span class="linenr">14: </span><span style="color: #98be65;">'''Data Prep and Model Evaluation'''</span>
<span class="linenr">15: </span><span style="color: #51afef;">from</span> sklearn <span style="color: #51afef;">import</span> preprocessing <span style="color: #51afef;">as</span> pp
<span class="linenr">16: </span><span style="color: #51afef;">from</span> sklearn.model_selection <span style="color: #51afef;">import</span> train_test_split
<span class="linenr">17: </span><span style="color: #51afef;">from</span> sklearn.model_selection <span style="color: #51afef;">import</span> StratifiedKFold
<span class="linenr">18: </span><span style="color: #51afef;">from</span> sklearn.metrics <span style="color: #51afef;">import</span> log_loss, accuracy_score
<span class="linenr">19: </span><span style="color: #51afef;">from</span> sklearn.metrics <span style="color: #51afef;">import</span> precision_recall_curve, average_precision_score
<span class="linenr">20: </span><span style="color: #51afef;">from</span> sklearn.metrics <span style="color: #51afef;">import</span> roc_curve, auc, roc_auc_score, mean_squared_error
<span class="linenr">21: </span>
<span class="linenr">22: </span><span style="color: #98be65;">'''Algos'''</span>
<span class="linenr">23: </span><span style="color: #51afef;">import</span> lightgbm <span style="color: #51afef;">as</span> lgb
<span class="linenr">24: </span>
<span class="linenr">25: </span><span style="color: #98be65;">'''TensorFlow and Keras'''</span>
<span class="linenr">26: </span><span style="color: #51afef;">import</span> tensorflow <span style="color: #51afef;">as</span> tf
<span class="linenr">27: </span><span style="color: #51afef;">from</span> tensorflow <span style="color: #51afef;">import</span> keras
<span class="linenr">28: </span><span style="color: #dcaeea;">K</span> = keras.backend
<span class="linenr">29: </span>
<span class="linenr">30: </span><span style="color: #51afef;">from</span> tensorflow.keras.models <span style="color: #51afef;">import</span> Sequential, Model
<span class="linenr">31: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Activation, Dense, Dropout
<span class="linenr">32: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> BatchNormalization, Input, Lambda
<span class="linenr">33: </span><span style="color: #51afef;">from</span> tensorflow.keras.layers <span style="color: #51afef;">import</span> Embedding, Flatten, dot
<span class="linenr">34: </span><span style="color: #51afef;">from</span> tensorflow.keras <span style="color: #51afef;">import</span> regularizers
<span class="linenr">35: </span><span style="color: #51afef;">from</span> tensorflow.keras.losses <span style="color: #51afef;">import</span> mse, binary_crossentropy
<span class="linenr">36: </span><span style="color: #51afef;">import</span> sys, sklearn
<span class="linenr">37: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'sklearn    </span>{sklearn.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">38: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'tensorflow </span>{tf.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">39: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'keras      </span>{keras.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">40: </span><span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">'numpy      </span>{np.__version__}<span style="color: #98be65;">'</span>)
<span class="linenr">41: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">To make the output stable across runs</span>
<span class="linenr">42: </span>tf.random.set_seed(<span style="color: #da8548; font-weight: bold;">42</span>)
<span class="linenr">43: </span>np.random.seed(<span style="color: #da8548; font-weight: bold;">42</span>)
</pre>
</div>

<pre class="example">
Python 3.7.13 (default, Mar 28 2022, 07:24:34)
[Clang 12.0.0 ] :: Anaconda, Inc. on darwin
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; sklearn    1.0.2
tensorflow 2.0.0
keras      2.2.4-tf
numpy      1.21.5
</pre>
</div>
</div>
<div id="outline-container-org992d0ae" class="outline-4">
<h4 id="org992d0ae"><span class="section-number-4">6.1.2.</span> 資料準備</h4>
<div class="outline-text-4" id="text-6-1-2">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the datasets</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">current_path</span> = os.getcwd()
<span class="linenr"> 3: </span><span style="color: #c678dd;">file</span> = os.path.sep.join([<span style="color: #98be65;">''</span>, <span style="color: #98be65;">'dataset'</span>, <span style="color: #98be65;">'mnist.pkl.gz'</span>])
<span class="linenr"> 4: </span><span style="color: #dcaeea;">f</span> = gzip.<span style="color: #c678dd;">open</span>(current_path+<span style="color: #c678dd;">file</span>, <span style="color: #98be65;">'rb'</span>)
<span class="linenr"> 5: </span><span style="color: #dcaeea;">train_set</span>, <span style="color: #dcaeea;">validation_set</span>, <span style="color: #dcaeea;">test_set</span> = pickle.load(f, encoding=<span style="color: #98be65;">'latin1'</span>)
<span class="linenr"> 6: </span>f.close()
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span style="color: #dcaeea;">X_train</span>, <span style="color: #dcaeea;">y_train</span> = train_set[<span style="color: #da8548; font-weight: bold;">0</span>], train_set[<span style="color: #da8548; font-weight: bold;">1</span>]
<span class="linenr"> 9: </span><span style="color: #dcaeea;">X_validation</span>, <span style="color: #dcaeea;">y_validation</span> = validation_set[<span style="color: #da8548; font-weight: bold;">0</span>], validation_set[<span style="color: #da8548; font-weight: bold;">1</span>]
<span class="linenr">10: </span><span style="color: #dcaeea;">X_test</span>, <span style="color: #dcaeea;">y_test</span> = test_set[<span style="color: #da8548; font-weight: bold;">0</span>], test_set[<span style="color: #da8548; font-weight: bold;">1</span>]
<span class="linenr">11: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Verify shape of datasets</span>
<span class="linenr">12: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Shape of X_train: "</span>, X_train.shape)
<span class="linenr">13: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Shape of y_train: "</span>, y_train.shape)
<span class="linenr">14: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Shape of X_validation: "</span>, X_validation.shape)
<span class="linenr">15: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Shape of y_validation: "</span>, y_validation.shape)
<span class="linenr">16: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Shape of X_test: "</span>, X_test.shape)
<span class="linenr">17: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Shape of y_test: "</span>, y_test.shape)
</pre>
</div>

<pre class="example">
Shape of X_train:  (50000, 784)
Shape of y_train:  (50000,)
Shape of X_validation:  (10000, 784)
Shape of y_validation:  (10000,)
Shape of X_test:  (10000, 784)
Shape of y_test:  (10000,)
</pre>
</div>
</div>
<div id="outline-container-orgc8ad4b6" class="outline-4">
<h4 id="orgc8ad4b6"><span class="section-number-4">6.1.3.</span> 建立資料集</h4>
<div class="outline-text-4" id="text-6-1-3">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create Pandas DataFrames from the datasets</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">train_index</span> = <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #c678dd;">len</span>(X_train))
<span class="linenr"> 3: </span><span style="color: #dcaeea;">validation_index</span> = <span style="color: #c678dd;">range</span>(<span style="color: #c678dd;">len</span>(X_train),<span style="color: #c678dd;">len</span>(X_train)+<span style="color: #c678dd;">len</span>(X_validation))
<span class="linenr"> 4: </span><span style="color: #dcaeea;">test_index</span> = <span style="color: #c678dd;">range</span>(<span style="color: #c678dd;">len</span>(X_train)+<span style="color: #c678dd;">len</span>(X_validation), \
<span class="linenr"> 5: </span>                   <span style="color: #c678dd;">len</span>(X_train)+<span style="color: #c678dd;">len</span>(X_validation)+<span style="color: #c678dd;">len</span>(X_test))
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #dcaeea;">X_train</span> = pd.DataFrame(data=X_train,index=train_index)
<span class="linenr"> 8: </span><span style="color: #dcaeea;">y_train</span> = pd.Series(data=y_train,index=train_index)
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #dcaeea;">X_validation</span> = pd.DataFrame(data=X_validation,index=validation_index)
<span class="linenr">11: </span><span style="color: #dcaeea;">y_validation</span> = pd.Series(data=y_validation,index=validation_index)
<span class="linenr">12: </span>
<span class="linenr">13: </span><span style="color: #dcaeea;">X_test</span> = pd.DataFrame(data=X_test,index=test_index)
<span class="linenr">14: </span><span style="color: #dcaeea;">y_test</span> = pd.Series(data=y_test,index=test_index)
<span class="linenr">15: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Describe the training matrix</span>
<span class="linenr">16: </span><span style="color: #c678dd;">print</span>(X_train.describe())
</pre>
</div>

<pre class="example" id="orgff4715c">
           0        1        2        3        4        5        6    ...           777           778           779      780      781      782      783
count  50000.0  50000.0  50000.0  50000.0  50000.0  50000.0  50000.0  ...  50000.000000  50000.000000  50000.000000  50000.0  50000.0  50000.0  50000.0
mean       0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.000090      0.000071      0.000009      0.0      0.0      0.0      0.0
std        0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.007217      0.007181      0.001483      0.0      0.0      0.0      0.0
min        0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.000000      0.000000      0.000000      0.0      0.0      0.0      0.0
25%        0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.000000      0.000000      0.000000      0.0      0.0      0.0      0.0
50%        0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.000000      0.000000      0.000000      0.0      0.0      0.0      0.0
75%        0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.000000      0.000000      0.000000      0.0      0.0      0.0      0.0
max        0.0      0.0      0.0      0.0      0.0      0.0      0.0  ...      0.988281      0.992188      0.242188      0.0      0.0      0.0      0.0

[8 rows x 784 columns]
</pre>
</div>
</div>
<div id="outline-container-org665fa93" class="outline-4">
<h4 id="org665fa93"><span class="section-number-4">6.1.4.</span> View the digit image</h4>
<div class="outline-text-4" id="text-6-1-4">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #51afef;">def</span> <span style="color: #c678dd;">view_digit</span>(X, y, example, fn):
<span class="linenr"> 2: </span>    plt.cla()
<span class="linenr"> 3: </span>    <span style="color: #dcaeea;">label</span> = y.loc[example]
<span class="linenr"> 4: </span>    <span style="color: #dcaeea;">image</span> = X.loc[example,:].values.reshape([<span style="color: #da8548; font-weight: bold;">28</span>,<span style="color: #da8548; font-weight: bold;">28</span>])
<span class="linenr"> 5: </span>    plt.title(<span style="color: #98be65;">'Example: %d  Label: %d'</span> % (example, label))
<span class="linenr"> 6: </span>    plt.imshow(image, cmap=plt.get_cmap(<span style="color: #98be65;">'gray'</span>))
<span class="linenr"> 7: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.show()</span>
<span class="linenr"> 8: </span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#35201;&#23384;&#27284;&#30340;&#35441;&#23601;&#19981;&#35201;&#29992;show()?</span>
<span class="linenr"> 9: </span>    plt.tight_layout()
<span class="linenr">10: </span>    plt.savefig(fn, dpi=<span style="color: #da8548; font-weight: bold;">300</span>, bbox_inches = <span style="color: #98be65;">'tight'</span>)
<span class="linenr">11: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">View the first digit</span>
<span class="linenr">12: </span>view_digit(X_train, y_train, <span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #98be65;">'images/firsttest.png'</span>)
</pre>
</div>


<div id="org69effe0" class="figure">
<p><img src="images/firsttest.png" alt="firsttest.png" width="500" />
</p>
<p><span class="figure-number">Figure 5: </span>Caption</p>
</div>
</div>
</div>
<div id="outline-container-org8b24017" class="outline-4">
<h4 id="org8b24017"><span class="section-number-4">6.1.5.</span> 將label以one-hot encoding編碼</h4>
<div class="outline-text-4" id="text-6-1-5">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #51afef;">def</span> <span style="color: #c678dd;">one_hot</span>(series):
<span class="linenr"> 2: </span>    <span style="color: #dcaeea;">label_binarizer</span> = pp.LabelBinarizer()
<span class="linenr"> 3: </span>    label_binarizer.fit(<span style="color: #c678dd;">range</span>(<span style="color: #c678dd;">max</span>(series)+<span style="color: #da8548; font-weight: bold;">1</span>))
<span class="linenr"> 4: </span>    <span style="color: #51afef;">return</span> label_binarizer.transform(series)
<span class="linenr"> 5: </span><span style="color: #51afef;">def</span> <span style="color: #c678dd;">reverse_one_hot</span>(originalSeries, newSeries):
<span class="linenr"> 6: </span>    <span style="color: #dcaeea;">label_binarizer</span> = pp.LabelBinarizer()
<span class="linenr"> 7: </span>    label_binarizer.fit(<span style="color: #c678dd;">range</span>(<span style="color: #c678dd;">max</span>(originalSeries)+<span style="color: #da8548; font-weight: bold;">1</span>))
<span class="linenr"> 8: </span>    <span style="color: #51afef;">return</span> label_binarizer.inverse_transform(newSeries)
<span class="linenr"> 9: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create one-hot vectors for the labels</span>
<span class="linenr">10: </span><span style="color: #dcaeea;">y_train_oneHot</span> = one_hot(y_train)
<span class="linenr">11: </span><span style="color: #dcaeea;">y_validation_oneHot</span> = one_hot(y_validation)
<span class="linenr">12: </span><span style="color: #dcaeea;">y_test_oneHot</span> = one_hot(y_test)
<span class="linenr">13: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Show one-hot vector for example 0, which is the number 5</span>
<span class="linenr">14: </span><span style="color: #c678dd;">print</span>(y_train[<span style="color: #da8548; font-weight: bold;">0</span>])
<span class="linenr">15: </span><span style="color: #c678dd;">print</span>(y_train_oneHot[<span style="color: #da8548; font-weight: bold;">0</span>])
</pre>
</div>

<pre class="example">
5
[0 0 0 0 0 1 0 0 0 0]
</pre>

<p>
圖<a href="#org69effe0">5</a>的label和相對應的one-hot encoding如下:
</p>
<pre class="example">
5
[0 0 0 0 0 1 0 0 0 0]
</pre>
</div>
</div>
</div>
<div id="outline-container-orga7e4182" class="outline-3">
<h3 id="orga7e4182"><span class="section-number-3">6.2.</span> Restricted Boltzmann Machines (RBMs)</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">  1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Make code compatible with v1 of TF</span>
<span class="linenr">  2: </span>tf.compat.v1.disable_eager_execution()
<span class="linenr">  3: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define RBM class</span>
<span class="linenr">  4: </span><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">RBM</span>(<span style="color: #c678dd;">object</span>):
<span class="linenr">  5: </span>
<span class="linenr">  6: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">__init__</span>(<span style="color: #51afef;">self</span>, input_size, output_size,
<span class="linenr">  7: </span>                 learning_rate, epochs, batchsize):
<span class="linenr">  8: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define hyperparameters</span>
<span class="linenr">  9: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_input_size</span> = input_size
<span class="linenr"> 10: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_output_size</span> = output_size
<span class="linenr"> 11: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">learning_rate</span> = learning_rate
<span class="linenr"> 12: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">epochs</span> = epochs
<span class="linenr"> 13: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">batchsize</span> = batchsize
<span class="linenr"> 14: </span>
<span class="linenr"> 15: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Initialize weights and biases using zero matrices</span>
<span class="linenr"> 16: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">w</span> = np.zeros([input_size, output_size], dtype=np.float32)
<span class="linenr"> 17: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">hb</span> = np.zeros([output_size], dtype=np.float32)
<span class="linenr"> 18: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">vb</span> = np.zeros([input_size], dtype=np.float32)
<span class="linenr"> 19: </span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#27491;&#21521;&#20659;&#36958;</span>
<span class="linenr"> 20: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">prob_h_given_v</span>(<span style="color: #51afef;">self</span>, visible, w, hb):
<span class="linenr"> 21: </span>        <span style="color: #51afef;">return</span> tf.nn.sigmoid(tf.matmul(visible, w) + hb)
<span class="linenr"> 22: </span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#21453;&#21521;&#20659;&#36958;</span>
<span class="linenr"> 23: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">prob_v_given_h</span>(<span style="color: #51afef;">self</span>, hidden, w, vb):
<span class="linenr"> 24: </span>        <span style="color: #51afef;">return</span> tf.nn.sigmoid(tf.matmul(hidden, tf.transpose(w)) + vb)
<span class="linenr"> 25: </span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#25506;&#27171;</span>
<span class="linenr"> 26: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">sample_prob</span>(<span style="color: #51afef;">self</span>, probs):
<span class="linenr"> 27: </span>        <span style="color: #51afef;">return</span> tf.nn.relu(tf.sign(probs - tf.compat.v1.random_uniform(tf.shape(probs))))
<span class="linenr"> 28: </span>
<span class="linenr"> 29: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">train</span>(<span style="color: #51afef;">self</span>, X):
<span class="linenr"> 30: </span>        <span style="color: #dcaeea;">_w</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size])
<span class="linenr"> 31: </span>        <span style="color: #dcaeea;">_hb</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #51afef;">self</span>._output_size])
<span class="linenr"> 32: </span>        <span style="color: #dcaeea;">_vb</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #51afef;">self</span>._input_size])
<span class="linenr"> 33: </span>
<span class="linenr"> 34: </span>        <span style="color: #dcaeea;">prv_w</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr"> 35: </span>        <span style="color: #dcaeea;">prv_hb</span> = np.zeros([<span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr"> 36: </span>        <span style="color: #dcaeea;">prv_vb</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size], dtype=np.float32)
<span class="linenr"> 37: </span>
<span class="linenr"> 38: </span>        <span style="color: #dcaeea;">cur_w</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr"> 39: </span>        <span style="color: #dcaeea;">cur_hb</span> = np.zeros([<span style="color: #51afef;">self</span>._output_size], dtype=np.float32)
<span class="linenr"> 40: </span>        <span style="color: #dcaeea;">cur_vb</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size], dtype=np.float32)
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span>        <span style="color: #dcaeea;">v0</span> = tf.compat.v1.placeholder(tf.float32, [<span style="color: #a9a1e1;">None</span>, <span style="color: #51afef;">self</span>._input_size])
<span class="linenr"> 43: </span>        <span style="color: #dcaeea;">h0</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_h_given_v(v0, _w, _hb))
<span class="linenr"> 44: </span>        <span style="color: #dcaeea;">v1</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_v_given_h(h0, _w, _vb))
<span class="linenr"> 45: </span>        <span style="color: #dcaeea;">h1</span> = <span style="color: #51afef;">self</span>.prob_h_given_v(v1, _w, _hb)
<span class="linenr"> 46: </span>
<span class="linenr"> 47: </span>        <span style="color: #dcaeea;">positive_grad</span> = tf.matmul(tf.transpose(v0), h0)
<span class="linenr"> 48: </span>        <span style="color: #dcaeea;">negative_grad</span> = tf.matmul(tf.transpose(v1), h1)
<span class="linenr"> 49: </span>
<span class="linenr"> 50: </span>        <span style="color: #dcaeea;">update_w</span> = _w + <span style="color: #51afef;">self</span>.learning_rate * \
<span class="linenr"> 51: </span>            (positive_grad - negative_grad) / tf.cast(tf.shape(v0)[<span style="color: #da8548; font-weight: bold;">0</span>], tf.float32)
<span class="linenr"> 52: </span>        <span style="color: #dcaeea;">update_vb</span> = _vb +  <span style="color: #51afef;">self</span>.learning_rate * tf.reduce_mean(v0 - v1, <span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr"> 53: </span>        <span style="color: #dcaeea;">update_hb</span> = _hb +  <span style="color: #51afef;">self</span>.learning_rate * tf.reduce_mean(h0 - h1, <span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr"> 54: </span>
<span class="linenr"> 55: </span>        <span style="color: #dcaeea;">err</span> = tf.reduce_mean(tf.square(v0 - v1))
<span class="linenr"> 56: </span>
<span class="linenr"> 57: </span>        <span style="color: #dcaeea;">error_list</span> = []
<span class="linenr"> 58: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#25209;&#27425;&#20659;&#20837;&#36039;&#26009;&#20006;&#38283;&#22987;&#35347;&#32244;</span>
<span class="linenr"> 59: </span>        <span style="color: #51afef;">with</span> tf.compat.v1.Session() <span style="color: #51afef;">as</span> sess:
<span class="linenr"> 60: </span>            sess.run(tf.compat.v1.global_variables_initializer())
<span class="linenr"> 61: </span>
<span class="linenr"> 62: </span>            <span style="color: #51afef;">for</span> epoch <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #51afef;">self</span>.epochs):
<span class="linenr"> 63: </span>                <span style="color: #51afef;">for</span> start, end <span style="color: #51afef;">in</span> <span style="color: #c678dd;">zip</span>(<span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #c678dd;">len</span>(X), \
<span class="linenr"> 64: </span>                        <span style="color: #51afef;">self</span>.batchsize),<span style="color: #c678dd;">range</span>(<span style="color: #51afef;">self</span>.batchsize,<span style="color: #c678dd;">len</span>(X), \
<span class="linenr"> 65: </span>                                              <span style="color: #51afef;">self</span>.batchsize)):
<span class="linenr"> 66: </span>                    <span style="color: #dcaeea;">batch</span> = X[start:end]
<span class="linenr"> 67: </span>                    <span style="color: #dcaeea;">cur_w</span> = sess.run(update_w, feed_dict={v0: batch, \
<span class="linenr"> 68: </span>                                    _w: prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr"> 69: </span>                    <span style="color: #dcaeea;">cur_hb</span> = sess.run(update_hb, feed_dict={v0: batch, \
<span class="linenr"> 70: </span>                                    _w: prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr"> 71: </span>                    <span style="color: #dcaeea;">cur_vb</span> = sess.run(update_vb, feed_dict={v0: batch, \
<span class="linenr"> 72: </span>                                    _w: prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr"> 73: </span>                    <span style="color: #dcaeea;">prv_w</span> = cur_w
<span class="linenr"> 74: </span>                    <span style="color: #dcaeea;">prv_hb</span> = cur_hb
<span class="linenr"> 75: </span>                    <span style="color: #dcaeea;">prv_vb</span> = cur_vb
<span class="linenr"> 76: </span>                <span style="color: #dcaeea;">error</span> = sess.run(err, feed_dict={v0: X, \
<span class="linenr"> 77: </span>                                _w: cur_w, _vb: cur_vb, _hb: cur_hb})
<span class="linenr"> 78: </span>                <span style="color: #c678dd;">print</span> (<span style="color: #98be65;">'Epoch: %d'</span> % epoch,<span style="color: #98be65;">'reconstruction error: %f'</span> % error)
<span class="linenr"> 79: </span>                error_list.append(error)
<span class="linenr"> 80: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">w</span> = prv_w
<span class="linenr"> 81: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">hb</span> = prv_hb
<span class="linenr"> 82: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">vb</span> = prv_vb
<span class="linenr"> 83: </span>            <span style="color: #51afef;">return</span> error_list
<span class="linenr"> 84: </span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#20351;&#29992;RBM&#27169;&#22411;&#29986;&#29983;&#24433;&#20687;</span>
<span class="linenr"> 85: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">rbm_output</span>(<span style="color: #51afef;">self</span>, X):
<span class="linenr"> 86: </span>
<span class="linenr"> 87: </span>        <span style="color: #dcaeea;">input_X</span> = tf.constant(X)
<span class="linenr"> 88: </span>        <span style="color: #dcaeea;">_w</span> = tf.constant(<span style="color: #51afef;">self</span>.w)
<span class="linenr"> 89: </span>        <span style="color: #dcaeea;">_hb</span> = tf.constant(<span style="color: #51afef;">self</span>.hb)
<span class="linenr"> 90: </span>        <span style="color: #dcaeea;">_vb</span> = tf.constant(<span style="color: #51afef;">self</span>.vb)
<span class="linenr"> 91: </span>        <span style="color: #dcaeea;">out</span> = tf.nn.sigmoid(tf.matmul(input_X, _w) + _hb)
<span class="linenr"> 92: </span>        <span style="color: #dcaeea;">hiddenGen</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_h_given_v(input_X, _w, _hb))
<span class="linenr"> 93: </span>        <span style="color: #dcaeea;">visibleGen</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_v_given_h(hiddenGen, _w, _vb))
<span class="linenr"> 94: </span>        <span style="color: #51afef;">with</span> tf.compat.v1.Session() <span style="color: #51afef;">as</span> sess:
<span class="linenr"> 95: </span>            sess.run(tf.compat.v1.global_variables_initializer())
<span class="linenr"> 96: </span>            <span style="color: #51afef;">return</span> sess.run(out), sess.run(visibleGen), sess.run(hiddenGen)
<span class="linenr"> 97: </span>    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#26597;&#30475;&#38577;&#34255;&#23652;&#30340;&#29305;&#24501;</span>
<span class="linenr"> 98: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">show_features</span>(<span style="color: #51afef;">self</span>, shape, suptitle, count=-<span style="color: #da8548; font-weight: bold;">1</span>, fn=<span style="color: #98be65;">''</span>):
<span class="linenr"> 99: </span>        <span style="color: #dcaeea;">maxw</span> = np.amax(<span style="color: #51afef;">self</span>.w.T)
<span class="linenr">100: </span>        <span style="color: #dcaeea;">minw</span> = np.amin(<span style="color: #51afef;">self</span>.w.T)
<span class="linenr">101: </span>        <span style="color: #dcaeea;">count</span> = <span style="color: #51afef;">self</span>._output_size <span style="color: #51afef;">if</span> count == -<span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">or</span> count &gt; \
<span class="linenr">102: </span>                <span style="color: #51afef;">self</span>._output_size <span style="color: #51afef;">else</span> count
<span class="linenr">103: </span>        <span style="color: #dcaeea;">ncols</span> = count <span style="color: #51afef;">if</span> count &lt; <span style="color: #da8548; font-weight: bold;">14</span> <span style="color: #51afef;">else</span> <span style="color: #da8548; font-weight: bold;">14</span>
<span class="linenr">104: </span>        <span style="color: #dcaeea;">nrows</span> = count//ncols
<span class="linenr">105: </span>        <span style="color: #dcaeea;">nrows</span> = nrows <span style="color: #51afef;">if</span> nrows &gt; <span style="color: #da8548; font-weight: bold;">2</span> <span style="color: #51afef;">else</span> <span style="color: #da8548; font-weight: bold;">3</span>
<span class="linenr">106: </span>        <span style="color: #dcaeea;">fig</span> = plt.figure(figsize=(ncols, nrows), dpi=<span style="color: #da8548; font-weight: bold;">100</span>)
<span class="linenr">107: </span>        <span style="color: #dcaeea;">grid</span> = Grid(fig, rect=<span style="color: #da8548; font-weight: bold;">111</span>, nrows_ncols=(nrows, ncols), axes_pad=<span style="color: #da8548; font-weight: bold;">0.01</span>)
<span class="linenr">108: </span>
<span class="linenr">109: </span>        <span style="color: #51afef;">for</span> i, ax <span style="color: #51afef;">in</span> <span style="color: #c678dd;">enumerate</span>(grid):
<span class="linenr">110: </span>            <span style="color: #dcaeea;">x</span> = <span style="color: #51afef;">self</span>.w.T[i] <span style="color: #51afef;">if</span> i&lt;<span style="color: #51afef;">self</span>._input_size <span style="color: #51afef;">else</span> np.zeros(shape)
<span class="linenr">111: </span>            <span style="color: #dcaeea;">x</span> = (x.reshape(<span style="color: #da8548; font-weight: bold;">1</span>, -<span style="color: #da8548; font-weight: bold;">1</span>) - minw)/maxw
<span class="linenr">112: </span>            ax.imshow(x.reshape(*shape), cmap=mpl.cm.Greys)
<span class="linenr">113: </span>            ax.set_axis_off()
<span class="linenr">114: </span>
<span class="linenr">115: </span>        fig.text(<span style="color: #da8548; font-weight: bold;">0.5</span>,<span style="color: #da8548; font-weight: bold;">1</span>, suptitle, fontsize=<span style="color: #da8548; font-weight: bold;">20</span>, horizontalalignment=<span style="color: #98be65;">'center'</span>)
<span class="linenr">116: </span>        fig.tight_layout()
<span class="linenr">117: </span>        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.show() #&#22914;&#20309;&#20659;&#22238;fig</span>
<span class="linenr">118: </span>        plt.savefig(fn, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
<span class="linenr">119: </span>        <span style="color: #51afef;">return</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org91a7e72" class="outline-3">
<h3 id="org91a7e72"><span class="section-number-3">6.3.</span> 為DBN訓練三個RBMs</h3>
<div class="outline-text-3" id="text-6-3">
<ol class="org-ol">
<li>先將訓練資料存成Numpy陣列</li>
<li>建立一個陣列(rbm_list)來保存所訓練的RMBs</li>
<li>定義三個RBM的超參數(輸入值數量、輸出值數量、學習率、訓練回合數、批次大小)</li>
</ol>
<p>
此模型中：
</p>
<ul class="org-ul">
<li>第一個RBM接收784維的輸入、輸出700維的矩陣</li>
<li>下一個RBM使用前一個RBM輸出的700維矩陣為輸入，輸出一個600維的矩陣</li>
<li>最後一個RBM使用這600維的矩陣當成輸入、輸出一個500維的矩陣</li>
<li>學習率設為1.0</li>
<li>訓練100回合</li>
<li>批次大小設為200</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Since we are training, set input as training data</span>
<span class="linenr"> 2: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#25343;&#35347;&#32244;&#38598;&#30070;&#25104;&#36664;&#20837;</span>
<span class="linenr"> 3: </span><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span class="linenr"> 4: </span><span style="color: #dcaeea;">inputX</span> = np.array(X_train)
<span class="linenr"> 5: </span><span style="color: #dcaeea;">inputX</span> = inputX.astype(np.float32)
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create list to hold our RBMs</span>
<span class="linenr"> 8: </span><span style="color: #dcaeea;">rbm_list</span> = []
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define the parameters of the RBMs we will train</span>
<span class="linenr">11: </span>rbm_list.append(RBM(<span style="color: #da8548; font-weight: bold;">784</span>,<span style="color: #da8548; font-weight: bold;">700</span>,<span style="color: #da8548; font-weight: bold;">1.0</span>,<span style="color: #da8548; font-weight: bold;">100</span>,<span style="color: #da8548; font-weight: bold;">200</span>))
<span class="linenr">12: </span>rbm_list.append(RBM(<span style="color: #da8548; font-weight: bold;">700</span>,<span style="color: #da8548; font-weight: bold;">600</span>,<span style="color: #da8548; font-weight: bold;">1.0</span>,<span style="color: #da8548; font-weight: bold;">100</span>,<span style="color: #da8548; font-weight: bold;">200</span>))
<span class="linenr">13: </span>rbm_list.append(RBM(<span style="color: #da8548; font-weight: bold;">600</span>,<span style="color: #da8548; font-weight: bold;">500</span>,<span style="color: #da8548; font-weight: bold;">1.0</span>,<span style="color: #da8548; font-weight: bold;">100</span>,<span style="color: #da8548; font-weight: bold;">200</span>))
<span class="linenr">14: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#23559;&#35347;&#32244;&#36942;&#30340;RBM&#23384;&#22312;outputList</span>
<span class="linenr">15: </span><span style="color: #dcaeea;">outputList</span> = []
<span class="linenr">16: </span><span style="color: #dcaeea;">error_list</span> = []
<span class="linenr">17: </span><span style="color: #5B6268;">#</span><span style="color: #5B6268;">For each RBM in our list</span>
<span class="linenr">18: </span><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #c678dd;">len</span>(rbm_list)):
<span class="linenr">19: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'RBM'</span>, i+<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">20: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">Train a new one</span>
<span class="linenr">21: </span>    <span style="color: #dcaeea;">rbm</span> = rbm_list[i]
<span class="linenr">22: </span>    <span style="color: #dcaeea;">err</span> = rbm.train(inputX)
<span class="linenr">23: </span>    error_list.append(err)
<span class="linenr">24: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">Return the output layer</span>
<span class="linenr">25: </span>    <span style="color: #dcaeea;">outputX</span>, <span style="color: #dcaeea;">reconstructedX</span>, <span style="color: #dcaeea;">hiddenX</span> = rbm.rbm_output(inputX)
<span class="linenr">26: </span>    outputList.append(outputX)
<span class="linenr">27: </span>    <span style="color: #dcaeea;">inputX</span> = hiddenX
</pre>
</div>

<pre class="example" id="org020f401">
RBM 1
2022-05-14 23:52:49.162587: I tensorflow/core/platform/cpu_feature_guard.cc:145] This TensorFlow binary is optimized with Intel(R) MKL-DNN to use the following CPU instructions in performance critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in non-MKL-DNN operations, rebuild TensorFlow with the appropriate compiler flags.
2022-05-14 23:52:49.164433: I tensorflow/core/common_runtime/process_util.cc:115] Creating new thread pool with default inter op setting: 12. Tune using inter_op_parallelism_threads for best performance.
Epoch: 0 reconstruction error: 0.074801
...
Epoch: 99 reconstruction error: 0.038867
RBM 2
Epoch: 0 reconstruction error: 0.050241
...
Epoch: 99 reconstruction error: 0.018937
RBM 3
Epoch: 0 reconstruction error: 0.038833
...
Epoch: 99 reconstruction error: 0.017987
</pre>
</div>
</div>
<div id="outline-container-orgd9bd022" class="outline-3">
<h3 id="orgd9bd022"><span class="section-number-3">6.4.</span> 查看RBM誤差</h3>
<div class="outline-text-3" id="text-6-4">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot reconstruction errors</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr"> 3: </span><span style="color: #51afef;">for</span> err <span style="color: #51afef;">in</span> error_list:
<span class="linenr"> 4: </span>    plt.clf()
<span class="linenr"> 5: </span>    plt.cla()
<span class="linenr"> 6: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"RBM"</span>,i)
<span class="linenr"> 7: </span>    pd.Series(err).plot(logy=<span style="color: #a9a1e1;">False</span>)
<span class="linenr"> 8: </span>    plt.xlabel(<span style="color: #98be65;">"Epoch"</span>)
<span class="linenr"> 9: </span>    plt.ylabel(<span style="color: #98be65;">"Reconstruction Error"</span>)
<span class="linenr">10: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.ylim(0,1)</span>
<span class="linenr">11: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.show()</span>
<span class="linenr">12: </span>    plt.savefig(f<span style="color: #98be65;">'images/DBN-DMB-</span>{i}<span style="color: #98be65;">.png'</span>, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
<span class="linenr">13: </span>    <span style="color: #dcaeea;">i</span> += <span style="color: #da8548; font-weight: bold;">1</span>
</pre>
</div>

<pre class="example">
RBM 1
RBM 2
RBM 3
</pre>



<div id="orgd3e98d1" class="figure">
<p><img src="images/DBN-DMB-1.png" alt="DBN-DMB-1.png" width="500" />
</p>
<p><span class="figure-number">Figure 6: </span>Caption</p>
</div>

<div id="org932668d" class="figure">
<p><img src="images/DBN-DMB-2.png" alt="DBN-DMB-2.png" width="500" />
</p>
<p><span class="figure-number">Figure 7: </span>Caption</p>
</div>

<div id="orgcf0579c" class="figure">
<p><img src="images/DBN-DMB-3.png" alt="DBN-DMB-3.png" width="500" />
</p>
<p><span class="figure-number">Figure 8: </span>Caption</p>
</div>
</div>
</div>
<div id="outline-container-org3db1beb" class="outline-3">
<h3 id="org3db1beb"><span class="section-number-3">6.5.</span> 檢視特徵偵測器</h3>
<div class="outline-text-3" id="text-6-5">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Examine Feature Detectors</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">rbm_shapes</span> = [(<span style="color: #da8548; font-weight: bold;">28</span>,<span style="color: #da8548; font-weight: bold;">28</span>),(<span style="color: #da8548; font-weight: bold;">35</span>,<span style="color: #da8548; font-weight: bold;">20</span>),(<span style="color: #da8548; font-weight: bold;">30</span>,<span style="color: #da8548; font-weight: bold;">20</span>)]
<span class="linenr"> 3: </span><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #c678dd;">len</span>(rbm_list)):
<span class="linenr"> 4: </span>    <span style="color: #dcaeea;">rbm</span> = rbm_list[i]
<span class="linenr"> 5: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"RBM"</span>,i)
<span class="linenr"> 6: </span>    <span style="color: #dcaeea;">fn</span> = f<span style="color: #98be65;">'images/DBN-Detect-</span>{i}<span style="color: #98be65;">.png'</span>
<span class="linenr"> 7: </span>    <span style="color: #c678dd;">print</span>(rbm.show_features(rbm_shapes[i], <span style="color: #98be65;">"RBM learned features from MNIST"</span>, <span style="color: #da8548; font-weight: bold;">56</span>, fn))
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">fig = rbm.show_features(rbm_shapes[i])</span>
<span class="linenr"> 9: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.savefig(f'images/DBN-Detect-{i}.png', fig,  dpi=300)</span>
<span class="linenr">10: </span>
</pre>
</div>

<pre class="example">
RBM 0
None
RBM 1
None
RBM 2
None
</pre>



<div id="org237fa69" class="figure">
<p><img src="images/DBN-Detect-0.png" alt="DBN-Detect-0.png" width="500" />
</p>
<p><span class="figure-number">Figure 9: </span>Caption</p>
</div>

<div id="org9faecbb" class="figure">
<p><img src="images/DBN-Detect-1.png" alt="DBN-Detect-1.png" width="500" />
</p>
<p><span class="figure-number">Figure 10: </span>Caption</p>
</div>

<div id="org80fa643" class="figure">
<p><img src="images/DBN-Detect-2.png" alt="DBN-Detect-2.png" width="500" />
</p>
<p><span class="figure-number">Figure 11: </span>Caption</p>
</div>
</div>
</div>
<div id="outline-container-org007a827" class="outline-3">
<h3 id="org007a827"><span class="section-number-3">6.6.</span> 查看RBM生成的影像</h3>
<div class="outline-text-3" id="text-6-6">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">View generated images from the first RBM</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">inputX</span> = np.array(X_train)
<span class="linenr"> 3: </span><span style="color: #dcaeea;">rbmOne</span> = rbm_list[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'RBM 1'</span>)
<span class="linenr"> 6: </span><span style="color: #dcaeea;">outputX_rbmOne</span>, <span style="color: #dcaeea;">reconstructedX_rbmOne</span>, <span style="color: #dcaeea;">hiddenX_rbmOne</span> = \
<span class="linenr"> 7: </span>                            rbmOne.rbm_output(inputX)
<span class="linenr"> 8: </span><span style="color: #dcaeea;">reconstructedX_rbmOne</span> = pd.DataFrame(data=reconstructedX_rbmOne, \
<span class="linenr"> 9: </span>                                     index=X_train.index)
<span class="linenr">10: </span><span style="color: #51afef;">for</span> j <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">10</span>):
<span class="linenr">11: </span>    plt.cla()
<span class="linenr">12: </span>    plt.clf()
<span class="linenr">13: </span>    <span style="color: #dcaeea;">example</span> = j
<span class="linenr">14: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Image generated by RBM"</span>)
<span class="linenr">15: </span>    <span style="color: #dcaeea;">fn</span> = f<span style="color: #98be65;">'images/DBN-RBMGenerated-</span>{j}<span style="color: #98be65;">.png'</span>
<span class="linenr">16: </span>    view_digit(reconstructedX_rbmOne, y_train, example, fn)
<span class="linenr">17: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Original image"</span>)
<span class="linenr">18: </span>    <span style="color: #dcaeea;">fn</span> = f<span style="color: #98be65;">'images/DBN-Original-</span>{j}<span style="color: #98be65;">.png'</span>
<span class="linenr">19: </span>    view_digit(X_train, y_train, example, fn)
</pre>
</div>

<pre class="example" id="org4af7810">
RBM 1
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
Image generated by RBM
Original image
</pre>

<div id="org934c209" class="figure">
<p><img src="images/DBN-Original-9.png" alt="DBN-Original-9.png" width="500" />
</p>
<p><span class="figure-number">Figure 12: </span>Caption</p>
</div>
<p width="300">
<img src="images/DBN-RBMGenerated-9.png" alt="DBN-RBMGenerated-9.png" width="300" />
<img src="images/DBN-Original-8.png" alt="DBN-Original-8.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-8.png" alt="DBN-RBMGenerated-8.png" width="300" />
<img src="images/DBN-Original-7.png" alt="DBN-Original-7.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-7.png" alt="DBN-RBMGenerated-7.png" width="300" />
<img src="images/DBN-Original-6.png" alt="DBN-Original-6.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-6.png" alt="DBN-RBMGenerated-6.png" width="300" />
<img src="images/DBN-Original-5.png" alt="DBN-Original-5.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-5.png" alt="DBN-RBMGenerated-5.png" width="300" />
<img src="images/DBN-Original-4.png" alt="DBN-Original-4.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-4.png" alt="DBN-RBMGenerated-4.png" width="300" />
<img src="images/DBN-Original-3.png" alt="DBN-Original-3.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-3.png" alt="DBN-RBMGenerated-3.png" width="300" />
<img src="images/DBN-Original-2.png" alt="DBN-Original-2.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-2.png" alt="DBN-RBMGenerated-2.png" width="300" />
<img src="images/DBN-Original-1.png" alt="DBN-Original-1.png" />
</p>
<p width="300">
<img src="images/DBN-RBMGenerated-1.png" alt="DBN-RBMGenerated-1.png" width="300" />
<img src="images/DBN-Original-0.png" alt="DBN-Original-0.png" />
</p>

<div id="org34fa88a" class="figure">
<p><img src="images/DBN-RBMGenerated-0.png" alt="DBN-RBMGenerated-0.png" width="300" />
</p>
</div>
</div>
</div>
<div id="outline-container-org92ca7cf" class="outline-3">
<h3 id="org92ca7cf"><span class="section-number-3">6.7.</span> 完整的DBN</h3>
<div class="outline-text-3" id="text-6-7">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">  1: </span><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">DBN</span>(<span style="color: #c678dd;">object</span>):
<span class="linenr">  2: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">__init__</span>(<span style="color: #51afef;">self</span>, original_input_size, input_size, output_size,
<span class="linenr">  3: </span>                 learning_rate, epochs, batchsize, rbmOne, rbmTwo, rbmThree):
<span class="linenr">  4: </span>        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define hyperparameters</span>
<span class="linenr">  5: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_original_input_size</span> = original_input_size
<span class="linenr">  6: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_input_size</span> = input_size
<span class="linenr">  7: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">_output_size</span> = output_size
<span class="linenr">  8: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">learning_rate</span> = learning_rate
<span class="linenr">  9: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">epochs</span> = epochs
<span class="linenr"> 10: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">batchsize</span> = batchsize
<span class="linenr"> 11: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">rbmOne</span> = rbmOne
<span class="linenr"> 12: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">rbmTwo</span> = rbmTwo
<span class="linenr"> 13: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">rbmThree</span> = rbmThree
<span class="linenr"> 14: </span>
<span class="linenr"> 15: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">w</span> = np.zeros([input_size, output_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 16: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">hb</span> = np.zeros([output_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 17: </span>        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">vb</span> = np.zeros([input_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 18: </span>
<span class="linenr"> 19: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">prob_h_given_v</span>(<span style="color: #51afef;">self</span>, visible, w, hb):
<span class="linenr"> 20: </span>        <span style="color: #51afef;">return</span> tf.nn.sigmoid(tf.matmul(visible, w) + hb)
<span class="linenr"> 21: </span>
<span class="linenr"> 22: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">prob_v_given_h</span>(<span style="color: #51afef;">self</span>, hidden, w, vb):
<span class="linenr"> 23: </span>        <span style="color: #51afef;">return</span> tf.nn.sigmoid(tf.matmul(hidden, tf.transpose(w)) + vb)
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">sample_prob</span>(<span style="color: #51afef;">self</span>, probs):
<span class="linenr"> 26: </span>        <span style="color: #51afef;">return</span> tf.nn.relu(tf.sign(probs - tf.compat.v1.random_uniform(tf.shape(probs))))
<span class="linenr"> 27: </span>
<span class="linenr"> 28: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">train</span>(<span style="color: #51afef;">self</span>, X):
<span class="linenr"> 29: </span>        <span style="color: #dcaeea;">_w</span> = tf.compat.v1.placeholder(<span style="color: #98be65;">"float"</span>, [<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size])
<span class="linenr"> 30: </span>        <span style="color: #dcaeea;">_hb</span> = tf.compat.v1.placeholder(<span style="color: #98be65;">"float"</span>, [<span style="color: #51afef;">self</span>._output_size])
<span class="linenr"> 31: </span>        <span style="color: #dcaeea;">_vb</span> = tf.compat.v1.placeholder(<span style="color: #98be65;">"float"</span>, [<span style="color: #51afef;">self</span>._input_size])
<span class="linenr"> 32: </span>
<span class="linenr"> 33: </span>        <span style="color: #dcaeea;">prv_w</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 34: </span>        <span style="color: #dcaeea;">prv_hb</span> = np.zeros([<span style="color: #51afef;">self</span>._output_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 35: </span>        <span style="color: #dcaeea;">prv_vb</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 36: </span>
<span class="linenr"> 37: </span>        <span style="color: #dcaeea;">cur_w</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size, <span style="color: #51afef;">self</span>._output_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 38: </span>        <span style="color: #dcaeea;">cur_hb</span> = np.zeros([<span style="color: #51afef;">self</span>._output_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 39: </span>        <span style="color: #dcaeea;">cur_vb</span> = np.zeros([<span style="color: #51afef;">self</span>._input_size], <span style="color: #98be65;">"float"</span>)
<span class="linenr"> 40: </span>
<span class="linenr"> 41: </span>        <span style="color: #dcaeea;">v0</span> = tf.compat.v1.placeholder(<span style="color: #98be65;">"float"</span>, [<span style="color: #a9a1e1;">None</span>, <span style="color: #51afef;">self</span>._original_input_size])
<span class="linenr"> 42: </span>
<span class="linenr"> 43: </span>        <span style="color: #dcaeea;">forwardOne</span> = tf.nn.relu(tf.sign(tf.nn.sigmoid(tf.matmul(v0, \
<span class="linenr"> 44: </span>                        <span style="color: #51afef;">self</span>.rbmOne.w) + <span style="color: #51afef;">self</span>.rbmOne.hb) - tf.compat.v1.random_uniform( \
<span class="linenr"> 45: </span>                        tf.shape(tf.nn.sigmoid(tf.matmul(v0, <span style="color: #51afef;">self</span>.rbmOne.w) + \
<span class="linenr"> 46: </span>                        <span style="color: #51afef;">self</span>.rbmOne.hb)))))
<span class="linenr"> 47: </span>        <span style="color: #dcaeea;">forwardTwo</span> = tf.nn.relu(tf.sign(tf.nn.sigmoid(tf.matmul(forwardOne, \
<span class="linenr"> 48: </span>                        <span style="color: #51afef;">self</span>.rbmTwo.w) + <span style="color: #51afef;">self</span>.rbmTwo.hb) - tf.compat.v1.random_uniform( \
<span class="linenr"> 49: </span>                        tf.shape(tf.nn.sigmoid(tf.matmul(forwardOne, \
<span class="linenr"> 50: </span>                        <span style="color: #51afef;">self</span>.rbmTwo.w) + <span style="color: #51afef;">self</span>.rbmTwo.hb)))))
<span class="linenr"> 51: </span>        <span style="color: #dcaeea;">forward</span> = tf.nn.relu(tf.sign(tf.nn.sigmoid(tf.matmul(forwardTwo, \
<span class="linenr"> 52: </span>                        <span style="color: #51afef;">self</span>.rbmThree.w) + <span style="color: #51afef;">self</span>.rbmThree.hb) - \
<span class="linenr"> 53: </span>                        tf.compat.v1.random_uniform(tf.shape(tf.nn.sigmoid(tf.matmul( \
<span class="linenr"> 54: </span>                        forwardTwo, <span style="color: #51afef;">self</span>.rbmThree.w) + <span style="color: #51afef;">self</span>.rbmThree.hb)))))
<span class="linenr"> 55: </span>        <span style="color: #dcaeea;">h0</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_h_given_v(forward, _w, _hb))
<span class="linenr"> 56: </span>        <span style="color: #dcaeea;">v1</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_v_given_h(h0, _w, _vb))
<span class="linenr"> 57: </span>        <span style="color: #dcaeea;">h1</span> = <span style="color: #51afef;">self</span>.prob_h_given_v(v1, _w, _hb)
<span class="linenr"> 58: </span>
<span class="linenr"> 59: </span>        <span style="color: #dcaeea;">positive_grad</span> = tf.matmul(tf.transpose(forward), h0)
<span class="linenr"> 60: </span>        <span style="color: #dcaeea;">negative_grad</span> = tf.matmul(tf.transpose(v1), h1)
<span class="linenr"> 61: </span>
<span class="linenr"> 62: </span>        <span style="color: #dcaeea;">update_w</span> = _w + <span style="color: #51afef;">self</span>.learning_rate * (positive_grad - negative_grad) / \
<span class="linenr"> 63: </span>                        tf.cast(tf.shape(forward)[<span style="color: #da8548; font-weight: bold;">0</span>], tf.float32)
<span class="linenr"> 64: </span>        <span style="color: #dcaeea;">update_vb</span> = _vb +  <span style="color: #51afef;">self</span>.learning_rate * tf.reduce_mean(forward - v1, <span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr"> 65: </span>        <span style="color: #dcaeea;">update_hb</span> = _hb +  <span style="color: #51afef;">self</span>.learning_rate * tf.reduce_mean(h0 - h1, <span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr"> 66: </span>
<span class="linenr"> 67: </span>        <span style="color: #dcaeea;">backwardOne</span> = tf.nn.relu(tf.sign(tf.nn.sigmoid(tf.matmul(v1, \
<span class="linenr"> 68: </span>                            <span style="color: #51afef;">self</span>.rbmThree.w.T) + <span style="color: #51afef;">self</span>.rbmThree.vb) - \
<span class="linenr"> 69: </span>                            tf.compat.v1.random_uniform(tf.shape(tf.nn.sigmoid( \
<span class="linenr"> 70: </span>                            tf.matmul(v1, <span style="color: #51afef;">self</span>.rbmThree.w.T) + \
<span class="linenr"> 71: </span>                            <span style="color: #51afef;">self</span>.rbmThree.vb)))))
<span class="linenr"> 72: </span>        <span style="color: #dcaeea;">backwardTwo</span> = tf.nn.relu(tf.sign(tf.nn.sigmoid(tf.matmul(backwardOne, \
<span class="linenr"> 73: </span>                            <span style="color: #51afef;">self</span>.rbmTwo.w.T) + <span style="color: #51afef;">self</span>.rbmTwo.vb) - \
<span class="linenr"> 74: </span>                            tf.compat.v1.random_uniform(tf.shape(tf.nn.sigmoid( \
<span class="linenr"> 75: </span>                            tf.matmul(backwardOne, <span style="color: #51afef;">self</span>.rbmTwo.w.T) + \
<span class="linenr"> 76: </span>                            <span style="color: #51afef;">self</span>.rbmTwo.vb)))))
<span class="linenr"> 77: </span>        <span style="color: #dcaeea;">backward</span> = tf.nn.relu(tf.sign(tf.nn.sigmoid(tf.matmul(backwardTwo, \
<span class="linenr"> 78: </span>                            <span style="color: #51afef;">self</span>.rbmOne.w.T) + <span style="color: #51afef;">self</span>.rbmOne.vb) - \
<span class="linenr"> 79: </span>                            tf.compat.v1.random_uniform(tf.shape(tf.nn.sigmoid( \
<span class="linenr"> 80: </span>                            tf.matmul(backwardTwo, <span style="color: #51afef;">self</span>.rbmOne.w.T) + \
<span class="linenr"> 81: </span>                            <span style="color: #51afef;">self</span>.rbmOne.vb)))))
<span class="linenr"> 82: </span>
<span class="linenr"> 83: </span>        <span style="color: #dcaeea;">err</span> = tf.reduce_mean(tf.square(v0 - backward))
<span class="linenr"> 84: </span>        <span style="color: #dcaeea;">error_list</span> = []
<span class="linenr"> 85: </span>
<span class="linenr"> 86: </span>        <span style="color: #51afef;">with</span> tf.compat.v1.Session() <span style="color: #51afef;">as</span> sess:
<span class="linenr"> 87: </span>            sess.run(tf.compat.v1.global_variables_initializer())
<span class="linenr"> 88: </span>
<span class="linenr"> 89: </span>            <span style="color: #51afef;">for</span> epoch <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #51afef;">self</span>.epochs):
<span class="linenr"> 90: </span>                <span style="color: #51afef;">for</span> start, end <span style="color: #51afef;">in</span> <span style="color: #c678dd;">zip</span>(<span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #c678dd;">len</span>(X), <span style="color: #51afef;">self</span>.batchsize), \
<span class="linenr"> 91: </span>                        <span style="color: #c678dd;">range</span>(<span style="color: #51afef;">self</span>.batchsize,<span style="color: #c678dd;">len</span>(X), <span style="color: #51afef;">self</span>.batchsize)):
<span class="linenr"> 92: </span>                    <span style="color: #dcaeea;">batch</span> = X[start:end]
<span class="linenr"> 93: </span>                    <span style="color: #dcaeea;">cur_w</span> = sess.run(update_w, feed_dict={v0: batch, _w: \
<span class="linenr"> 94: </span>                                        prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr"> 95: </span>                    <span style="color: #dcaeea;">cur_hb</span> = sess.run(update_hb, feed_dict={v0: batch, _w: \
<span class="linenr"> 96: </span>                                        prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr"> 97: </span>                    <span style="color: #dcaeea;">cur_vb</span> = sess.run(update_vb, feed_dict={v0: batch, _w: \
<span class="linenr"> 98: </span>                                        prv_w, _hb: prv_hb, _vb: prv_vb})
<span class="linenr"> 99: </span>                    <span style="color: #dcaeea;">prv_w</span> = cur_w
<span class="linenr">100: </span>                    <span style="color: #dcaeea;">prv_hb</span> = cur_hb
<span class="linenr">101: </span>                    <span style="color: #dcaeea;">prv_vb</span> = cur_vb
<span class="linenr">102: </span>                <span style="color: #dcaeea;">error</span> = sess.run(err, feed_dict={v0: X, _w: cur_w, _vb: \
<span class="linenr">103: </span>                                    cur_vb, _hb: cur_hb})
<span class="linenr">104: </span>                <span style="color: #c678dd;">print</span> (<span style="color: #98be65;">'Epoch: %d'</span> % epoch,<span style="color: #98be65;">'reconstruction error: %f'</span> % error)
<span class="linenr">105: </span>                error_list.append(error)
<span class="linenr">106: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">w</span> = prv_w
<span class="linenr">107: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">hb</span> = prv_hb
<span class="linenr">108: </span>            <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">vb</span> = prv_vb
<span class="linenr">109: </span>            <span style="color: #51afef;">return</span> error_list
<span class="linenr">110: </span>    <span style="color: #5B6268;">#</span><span style="color: #5B6268;">&#24478;DBN&#29986;&#20986;&#29983;&#25104;&#24433;&#20687;&#65292;&#39023;&#31034;&#29305;&#24501;</span>
<span class="linenr">111: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">dbn_output</span>(<span style="color: #51afef;">self</span>, X):
<span class="linenr">112: </span>
<span class="linenr">113: </span>        <span style="color: #dcaeea;">input_X</span> = tf.constant(X)
<span class="linenr">114: </span>        <span style="color: #dcaeea;">forwardOne</span> = tf.nn.sigmoid(tf.matmul(input_X, <span style="color: #51afef;">self</span>.rbmOne.w) + \
<span class="linenr">115: </span>                                   <span style="color: #51afef;">self</span>.rbmOne.hb)
<span class="linenr">116: </span>        <span style="color: #dcaeea;">forwardTwo</span> = tf.nn.sigmoid(tf.matmul(forwardOne, <span style="color: #51afef;">self</span>.rbmTwo.w) + \
<span class="linenr">117: </span>                                   <span style="color: #51afef;">self</span>.rbmTwo.hb)
<span class="linenr">118: </span>        <span style="color: #dcaeea;">forward</span> = tf.nn.sigmoid(tf.matmul(forwardTwo, <span style="color: #51afef;">self</span>.rbmThree.w) + \
<span class="linenr">119: </span>                                <span style="color: #51afef;">self</span>.rbmThree.hb)
<span class="linenr">120: </span>
<span class="linenr">121: </span>        <span style="color: #dcaeea;">_w</span> = tf.constant(<span style="color: #51afef;">self</span>.w)
<span class="linenr">122: </span>        <span style="color: #dcaeea;">_hb</span> = tf.constant(<span style="color: #51afef;">self</span>.hb)
<span class="linenr">123: </span>        <span style="color: #dcaeea;">_vb</span> = tf.constant(<span style="color: #51afef;">self</span>.vb)
<span class="linenr">124: </span>
<span class="linenr">125: </span>        <span style="color: #dcaeea;">out</span> = tf.nn.sigmoid(tf.matmul(forward, _w) + _hb)
<span class="linenr">126: </span>        <span style="color: #dcaeea;">hiddenGen</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_h_given_v(forward, _w, _hb))
<span class="linenr">127: </span>        <span style="color: #dcaeea;">visibleGen</span> = <span style="color: #51afef;">self</span>.sample_prob(<span style="color: #51afef;">self</span>.prob_v_given_h(hiddenGen, _w, _vb))
<span class="linenr">128: </span>
<span class="linenr">129: </span>        <span style="color: #dcaeea;">backwardTwo</span> = tf.nn.sigmoid(tf.matmul(visibleGen, <span style="color: #51afef;">self</span>.rbmThree.w.T) + \
<span class="linenr">130: </span>                                    <span style="color: #51afef;">self</span>.rbmThree.vb)
<span class="linenr">131: </span>        <span style="color: #dcaeea;">backwardOne</span> = tf.nn.sigmoid(tf.matmul(backwardTwo, <span style="color: #51afef;">self</span>.rbmTwo.w.T) + \
<span class="linenr">132: </span>                                    <span style="color: #51afef;">self</span>.rbmTwo.vb)
<span class="linenr">133: </span>        <span style="color: #dcaeea;">backward</span> = tf.nn.sigmoid(tf.matmul(backwardOne, <span style="color: #51afef;">self</span>.rbmOne.w.T) + \
<span class="linenr">134: </span>                                 <span style="color: #51afef;">self</span>.rbmOne.vb)
<span class="linenr">135: </span>
<span class="linenr">136: </span>        <span style="color: #51afef;">with</span> tf.compat.v1.Session() <span style="color: #51afef;">as</span> sess:
<span class="linenr">137: </span>            sess.run(tf.compat.v1.global_variables_initializer())
<span class="linenr">138: </span>            <span style="color: #51afef;">return</span> sess.run(out), sess.run(backward)
<span class="linenr">139: </span>
<span class="linenr">140: </span>    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">show_features</span>(<span style="color: #51afef;">self</span>, shape, suptitle, count=-<span style="color: #da8548; font-weight: bold;">1</span>, fn=<span style="color: #98be65;">''</span>):
<span class="linenr">141: </span>        plt.cla()
<span class="linenr">142: </span>        <span style="color: #dcaeea;">maxw</span> = np.amax(<span style="color: #51afef;">self</span>.w.T)
<span class="linenr">143: </span>        <span style="color: #dcaeea;">minw</span> = np.amin(<span style="color: #51afef;">self</span>.w.T)
<span class="linenr">144: </span>        <span style="color: #dcaeea;">count</span> = <span style="color: #51afef;">self</span>._output_size <span style="color: #51afef;">if</span> count == -<span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">or</span> count &gt; \
<span class="linenr">145: </span>                <span style="color: #51afef;">self</span>._output_size <span style="color: #51afef;">else</span> count
<span class="linenr">146: </span>        <span style="color: #dcaeea;">ncols</span> = count <span style="color: #51afef;">if</span> count &lt; <span style="color: #da8548; font-weight: bold;">14</span> <span style="color: #51afef;">else</span> <span style="color: #da8548; font-weight: bold;">14</span>
<span class="linenr">147: </span>        <span style="color: #dcaeea;">nrows</span> = count//ncols
<span class="linenr">148: </span>        <span style="color: #dcaeea;">nrows</span> = nrows <span style="color: #51afef;">if</span> nrows &gt; <span style="color: #da8548; font-weight: bold;">2</span> <span style="color: #51afef;">else</span> <span style="color: #da8548; font-weight: bold;">3</span>
<span class="linenr">149: </span>        <span style="color: #dcaeea;">fig</span> = plt.figure(figsize=(ncols, nrows), dpi=<span style="color: #da8548; font-weight: bold;">100</span>)
<span class="linenr">150: </span>        <span style="color: #dcaeea;">grid</span> = Grid(fig, rect=<span style="color: #da8548; font-weight: bold;">111</span>, nrows_ncols=(nrows, ncols), axes_pad=<span style="color: #da8548; font-weight: bold;">0.01</span>)
<span class="linenr">151: </span>
<span class="linenr">152: </span>        <span style="color: #51afef;">for</span> i, ax <span style="color: #51afef;">in</span> <span style="color: #c678dd;">enumerate</span>(grid):
<span class="linenr">153: </span>            <span style="color: #dcaeea;">x</span> = <span style="color: #51afef;">self</span>.w.T[i] <span style="color: #51afef;">if</span> i&lt;<span style="color: #51afef;">self</span>._input_size <span style="color: #51afef;">else</span> np.zeros(shape)
<span class="linenr">154: </span>            <span style="color: #dcaeea;">x</span> = (x.reshape(<span style="color: #da8548; font-weight: bold;">1</span>, -<span style="color: #da8548; font-weight: bold;">1</span>) - minw)/maxw
<span class="linenr">155: </span>            ax.imshow(x.reshape(*shape), cmap=mpl.cm.Greys)
<span class="linenr">156: </span>            ax.set_axis_off()
<span class="linenr">157: </span>
<span class="linenr">158: </span>        fig.text(<span style="color: #da8548; font-weight: bold;">0.5</span>,<span style="color: #da8548; font-weight: bold;">1</span>, suptitle, fontsize=<span style="color: #da8548; font-weight: bold;">20</span>, horizontalalignment=<span style="color: #98be65;">'center'</span>)
<span class="linenr">159: </span>        fig.tight_layout()
<span class="linenr">160: </span>        <span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.show()</span>
<span class="linenr">161: </span>        plt.savefig(fn, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
<span class="linenr">162: </span>        <span style="color: #51afef;">return</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgad9d0dc" class="outline-3">
<h3 id="orgad9d0dc"><span class="section-number-3">6.8.</span> 訓練DBN</h3>
<div class="outline-text-3" id="text-6-8">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Instantiate DBN Class</span>
<span class="linenr">2: </span><span style="color: #dcaeea;">dbn</span> = DBN(<span style="color: #da8548; font-weight: bold;">784</span>, <span style="color: #da8548; font-weight: bold;">500</span>, <span style="color: #da8548; font-weight: bold;">500</span>, <span style="color: #da8548; font-weight: bold;">1.0</span>, <span style="color: #da8548; font-weight: bold;">50</span>, <span style="color: #da8548; font-weight: bold;">200</span>, rbm_list[<span style="color: #da8548; font-weight: bold;">0</span>], rbm_list[<span style="color: #da8548; font-weight: bold;">1</span>], rbm_list[<span style="color: #da8548; font-weight: bold;">2</span>])
<span class="linenr">3: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Train</span>
<span class="linenr">4: </span><span style="color: #dcaeea;">inputX</span> = np.array(X_train)
<span class="linenr">5: </span><span style="color: #dcaeea;">error_list</span> = []
<span class="linenr">6: </span><span style="color: #dcaeea;">error_list</span> = dbn.train(inputX)
</pre>
</div>

<pre class="example" id="org1d0de40">
Epoch: 0 reconstruction error: 0.088701
....
Epoch: 49 reconstruction error: 0.060786
</pre>
</div>
</div>
<div id="outline-container-orgeda09d7" class="outline-3">
<h3 id="orgeda09d7"><span class="section-number-3">6.9.</span> 看錯誤</h3>
<div class="outline-text-3" id="text-6-9">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr">1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot reconstruction errors</span>
<span class="linenr">2: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"DBN"</span>)
<span class="linenr">3: </span>pd.Series(error_list).plot(logy=<span style="color: #a9a1e1;">False</span>)
<span class="linenr">4: </span>plt.xlabel(<span style="color: #98be65;">"Epoch"</span>)
<span class="linenr">5: </span>plt.ylabel(<span style="color: #98be65;">"Reconstruction Error"</span>)
<span class="linenr">6: </span><span style="color: #5B6268;">#</span><span style="color: #5B6268;">plt.show()</span>
<span class="linenr">7: </span>plt.savefig(<span style="color: #98be65;">'images/DBN-learned-MINST.png'</span>, dpi=<span style="color: #da8548; font-weight: bold;">300</span>)
<span class="linenr">8: </span><span style="color: #c678dd;">print</span>(dbn.show_features((<span style="color: #da8548; font-weight: bold;">25</span>,<span style="color: #da8548; font-weight: bold;">20</span>),<span style="color: #98be65;">"DBN learned features from MNIST"</span>, <span style="color: #da8548; font-weight: bold;">56</span>, <span style="color: #98be65;">'images/DBN-learned-from-MNIST.png'</span>))
</pre>
</div>

<pre class="example">
DBN
None
</pre>


<div id="org0cab56a" class="figure">
<p><img src="images/DBN-learned-MINST.png" alt="DBN-learned-MINST.png" width="500" />
</p>
<p><span class="figure-number">Figure 13: </span>Caption</p>
</div>

<div id="orge7f792c" class="figure">
<p><img src="images/DBN-learned-from-MNIST.png" alt="DBN-learned-from-MNIST.png" width="500" />
</p>
<p><span class="figure-number">Figure 14: </span>Caption</p>
</div>
</div>
</div>
<div id="outline-container-org1b3bb5b" class="outline-3">
<h3 id="org1b3bb5b"><span class="section-number-3">6.10.</span> 生成影像以建構更好的影像分類器</h3>
<div class="outline-text-3" id="text-6-10">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Generate images and store them</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">inputXReduced</span> = X_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>]
<span class="linenr"> 3: </span><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">20</span>):
<span class="linenr"> 4: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Run "</span>,i)
<span class="linenr"> 5: </span>    <span style="color: #dcaeea;">finalOutput_DBN</span>, <span style="color: #dcaeea;">reconstructedOutput_DBN</span> = dbn.dbn_output(inputXReduced)
<span class="linenr"> 6: </span>    <span style="color: #51afef;">if</span> i==<span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr"> 7: </span>        <span style="color: #dcaeea;">generatedImages</span> = finalOutput_DBN
<span class="linenr"> 8: </span>    <span style="color: #51afef;">else</span>:
<span class="linenr"> 9: </span>        <span style="color: #dcaeea;">generatedImages</span> = np.append(generatedImages, finalOutput_DBN, axis=<span style="color: #da8548; font-weight: bold;">0</span>)
<span class="linenr">10: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Generate a vector of labels for the generated images</span>
<span class="linenr">11: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#36941;&#27511;&#35347;&#32244;label y_train&#30340;&#21069;5000&#20491;label 20&#27425;&#65292;&#29992;&#20358;&#29986;&#29983;labels&#38499;&#21015;</span>
<span class="linenr">12: </span><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">20</span>):
<span class="linenr">13: </span>    <span style="color: #51afef;">if</span> i==<span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr">14: </span>        <span style="color: #dcaeea;">labels</span> = y_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>]
<span class="linenr">15: </span>    <span style="color: #51afef;">else</span>:
<span class="linenr">16: </span>        <span style="color: #dcaeea;">labels</span> = np.append(labels,y_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>])
<span class="linenr">17: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Generate images based on the validation set</span>
<span class="linenr">18: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#29986;&#29983;&#22522;&#26044;&#39511;&#35657;&#38598;&#30340;&#36664;&#20986;&#20540;(&#24433;&#20687;)</span>
<span class="linenr">19: </span><span style="color: #dcaeea;">inputValidation</span> = np.array(X_validation)
<span class="linenr">20: </span><span style="color: #dcaeea;">finalOutput_DBN_validation</span>, <span style="color: #dcaeea;">reconstructedOutput_DBN_validation</span> = \
<span class="linenr">21: </span>    dbn.dbn_output(inputValidation)
<span class="linenr">22: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">View first few reconstructed images</span>
<span class="linenr">23: </span><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">10</span>):
<span class="linenr">24: </span>    plt.cla()
<span class="linenr">25: </span>    plt.clf()
<span class="linenr">26: </span>    <span style="color: #dcaeea;">example</span> = i
<span class="linenr">27: </span>    <span style="color: #dcaeea;">reconstructedX</span> = pd.DataFrame(data=reconstructedOutput_DBN, \
<span class="linenr">28: </span>                                  index=X_train[<span style="color: #da8548; font-weight: bold;">0</span>:<span style="color: #da8548; font-weight: bold;">5000</span>].index)
<span class="linenr">29: </span>    <span style="color: #dcaeea;">fn</span> = f<span style="color: #98be65;">'images/reconstructedX-</span>{i}<span style="color: #98be65;">.png'</span>
<span class="linenr">30: </span>    view_digit(reconstructedX, y_train, example, fn)
<span class="linenr">31: </span>    <span style="color: #dcaeea;">fn</span> = f<span style="color: #98be65;">'images/X0train-</span>{i}<span style="color: #98be65;">.png'</span>
<span class="linenr">32: </span>    view_digit(X_train, y_train, example, fn)
</pre>
</div>

<pre class="example" id="org133e291">
Run  0
Run  1
Run  2
Run  3
Run  4
Run  5
Run  6
Run  7
Run  8
Run  9
Run  10
Run  11
Run  12
Run  13
Run  14
Run  15
Run  16
Run  17
Run  18
Run  19
</pre>

<div id="orgc0a13c4" class="figure">
<p><img src="images/X0train-0.png" alt="X0train-0.png" width="300" />
</p>
<p><span class="figure-number">Figure 15: </span>Run 1</p>
</div>

<div id="orge857b51" class="figure">
<p><img src="images/reconstructedX-0.png" alt="reconstructedX-0.png" width="300" />
</p>
</div>

<div id="org7079f67" class="figure">
<p><img src="images/X0train-1.png" alt="X0train-1.png" width="300" />
</p>
<p><span class="figure-number">Figure 16: </span>Run 2</p>
</div>

<div id="org0e3f1ec" class="figure">
<p><img src="images/reconstructedX-1.png" alt="reconstructedX-1.png" width="300" />
</p>
</div>

<div id="orgc60974a" class="figure">
<p><img src="images/X0train-2.png" alt="X0train-2.png" width="300" />
</p>
<p><span class="figure-number">Figure 17: </span>Run 3</p>
</div>

<div id="org65eef7d" class="figure">
<p><img src="images/reconstructedX-2.png" alt="reconstructedX-2.png" width="300" />
</p>
</div>

<div id="orgb24b7e6" class="figure">
<p><img src="images/X0train-3.png" alt="X0train-3.png" width="300" />
</p>
<p><span class="figure-number">Figure 18: </span>Run 4</p>
</div>

<div id="orga282a82" class="figure">
<p><img src="images/reconstructedX-3.png" alt="reconstructedX-3.png" width="300" />
</p>
</div>

<div id="org88299ce" class="figure">
<p><img src="images/X0train-4.png" alt="X0train-4.png" width="300" />
</p>
<p><span class="figure-number">Figure 19: </span>Run 5</p>
</div>

<div id="org1749044" class="figure">
<p><img src="images/reconstructedX-4.png" alt="reconstructedX-4.png" width="300" />
</p>
</div>

<div id="orgc1552b1" class="figure">
<p><img src="images/X0train-5.png" alt="X0train-5.png" width="300" />
</p>
<p><span class="figure-number">Figure 20: </span>Run 6</p>
</div>

<div id="org749c8f6" class="figure">
<p><img src="images/reconstructedX-5.png" alt="reconstructedX-5.png" width="300" />
</p>
</div>

<div id="org23777d2" class="figure">
<p><img src="images/X0train-6.png" alt="X0train-6.png" width="300" />
</p>
<p><span class="figure-number">Figure 21: </span>Run 7</p>
</div>

<div id="org8647a83" class="figure">
<p><img src="images/reconstructedX-6.png" alt="reconstructedX-6.png" width="300" />
</p>
</div>

<div id="org570b9f7" class="figure">
<p><img src="images/X0train-7.png" alt="X0train-7.png" width="300" />
</p>
<p><span class="figure-number">Figure 22: </span>Run 8</p>
</div>

<div id="org87a58ed" class="figure">
<p><img src="images/reconstructedX-7.png" alt="reconstructedX-7.png" width="300" />
</p>
</div>

<div id="orge872f3e" class="figure">
<p><img src="images/X0train-8.png" alt="X0train-8.png" width="300" />
</p>
<p><span class="figure-number">Figure 23: </span>Run 9</p>
</div>

<div id="orgb4cb53a" class="figure">
<p><img src="images/reconstructedX-8.png" alt="reconstructedX-8.png" width="300" />
</p>
</div>

<div id="org74b1331" class="figure">
<p><img src="images/X0train-9.png" alt="X0train-9.png" width="300" />
</p>
<p><span class="figure-number">Figure 24: </span>Run 10</p>
</div>

<div id="org042a57a" class="figure">
<p><img src="images/reconstructedX-9.png" alt="reconstructedX-9.png" width="300" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgfe47adb" class="outline-3">
<h3 id="orgfe47adb"><span class="section-number-3">6.11.</span> 使用DBN來產生新的影像10次</h3>
<div class="outline-text-3" id="text-6-11">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Generate the several versions of the first digit</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">inputXReduced</span> = X_train.loc[:<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr"> 3: </span><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">10</span>):
<span class="linenr"> 4: </span>    <span style="color: #dcaeea;">example</span> = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 5: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Run "</span>,i)
<span class="linenr"> 6: </span>    <span style="color: #dcaeea;">finalOutput_DBN_fives</span>, <span style="color: #dcaeea;">reconstructedOutput_DBN_fives</span> = \
<span class="linenr"> 7: </span>        dbn.dbn_output(inputXReduced)
<span class="linenr"> 8: </span>    <span style="color: #dcaeea;">reconstructedX_fives</span> = pd.DataFrame(data=reconstructedOutput_DBN_fives, \
<span class="linenr"> 9: </span>                                        index=[<span style="color: #da8548; font-weight: bold;">0</span>])
<span class="linenr">10: </span>    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Generated"</span>)
<span class="linenr">11: </span>    <span style="color: #dcaeea;">fn</span> = f<span style="color: #98be65;">'images/reconstructedX-fives-</span>{i}<span style="color: #98be65;">.png'</span>
<span class="linenr">12: </span>    view_digit(reconstructedX_fives, y_train.loc[:<span style="color: #da8548; font-weight: bold;">0</span>], example, fn)
</pre>
</div>

<pre class="example" id="org05920c1">
Run  0
Generated
Run  1
Generated
Run  2
Generated
Run  3
Generated
Run  4
Generated
Run  5
Generated
Run  6
Generated
Run  7
Generated
Run  8
Generated
Run  9
Generated
</pre>
</div>
</div>
<div id="outline-container-org33def2d" class="outline-3">
<h3 id="org33def2d"><span class="section-number-3">6.12.</span> 使用LightGBM建構影像分類器</h3>
<div class="outline-text-3" id="text-6-12">
</div>
<div id="outline-container-orga69348a" class="outline-4">
<h4 id="orga69348a"><span class="section-number-4">6.12.1.</span> 僅使用監督式學習</h4>
<div class="outline-text-4" id="text-6-12-1">
<p>
這裡先用前3000張有label的MNIST影像建立分類器當對照組
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Set Parameters</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">predictionColumns</span> = [<span style="color: #98be65;">'0'</span>,<span style="color: #98be65;">'1'</span>,<span style="color: #98be65;">'2'</span>,<span style="color: #98be65;">'3'</span>,<span style="color: #98be65;">'4'</span>,<span style="color: #98be65;">'5'</span>,<span style="color: #98be65;">'6'</span>,<span style="color: #98be65;">'7'</span>,<span style="color: #98be65;">'8'</span>,<span style="color: #98be65;">'9'</span>]
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span style="color: #dcaeea;">params_lightGB</span> = {
<span class="linenr"> 5: </span>    <span style="color: #98be65;">'task'</span>: <span style="color: #98be65;">'train'</span>,
<span class="linenr"> 6: </span>    <span style="color: #98be65;">'num_class'</span>:<span style="color: #da8548; font-weight: bold;">10</span>,
<span class="linenr"> 7: </span>    <span style="color: #98be65;">'boosting'</span>: <span style="color: #98be65;">'gbdt'</span>,
<span class="linenr"> 8: </span>    <span style="color: #98be65;">'objective'</span>: <span style="color: #98be65;">'multiclass'</span>,
<span class="linenr"> 9: </span>    <span style="color: #98be65;">'metric'</span>: <span style="color: #98be65;">'multi_logloss'</span>,
<span class="linenr">10: </span>    <span style="color: #98be65;">'metric_freq'</span>:<span style="color: #da8548; font-weight: bold;">50</span>,
<span class="linenr">11: </span>    <span style="color: #98be65;">'is_training_metric'</span>:<span style="color: #a9a1e1;">False</span>,
<span class="linenr">12: </span>    <span style="color: #98be65;">'max_depth'</span>:<span style="color: #da8548; font-weight: bold;">4</span>,
<span class="linenr">13: </span>    <span style="color: #98be65;">'num_leaves'</span>: <span style="color: #da8548; font-weight: bold;">31</span>,
<span class="linenr">14: </span>    <span style="color: #98be65;">'learning_rate'</span>: <span style="color: #da8548; font-weight: bold;">0.1</span>,
<span class="linenr">15: </span>    <span style="color: #98be65;">'feature_fraction'</span>: <span style="color: #da8548; font-weight: bold;">1.0</span>,
<span class="linenr">16: </span>    <span style="color: #98be65;">'bagging_fraction'</span>: <span style="color: #da8548; font-weight: bold;">1.0</span>,
<span class="linenr">17: </span>    <span style="color: #98be65;">'bagging_freq'</span>: <span style="color: #da8548; font-weight: bold;">0</span>,
<span class="linenr">18: </span>    <span style="color: #98be65;">'bagging_seed'</span>: <span style="color: #da8548; font-weight: bold;">2018</span>,
<span class="linenr">19: </span>    <span style="color: #98be65;">'verbose'</span>: -<span style="color: #da8548; font-weight: bold;">1</span>,
<span class="linenr">20: </span>    <span style="color: #98be65;">'num_threads'</span>:<span style="color: #da8548; font-weight: bold;">16</span>
<span class="linenr">21: </span>}
<span class="linenr">22: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Train</span>
<span class="linenr">23: </span><span style="color: #dcaeea;">trainingScore</span> = []
<span class="linenr">24: </span><span style="color: #dcaeea;">validationScore</span> = []
<span class="linenr">25: </span><span style="color: #dcaeea;">predictionsLightGBM</span> = pd.DataFrame(data=[], \
<span class="linenr">26: </span>                        index=y_validation.index, \
<span class="linenr">27: </span>                        columns=predictionColumns)
<span class="linenr">28: </span>
<span class="linenr">29: </span><span style="color: #dcaeea;">lgb_train</span> = lgb.Dataset(X_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>], y_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>])
<span class="linenr">30: </span><span style="color: #dcaeea;">lgb_eval</span> = lgb.Dataset(X_validation, y_validation, reference=lgb_train)
<span class="linenr">31: </span><span style="color: #dcaeea;">gbm</span> = lgb.train(params_lightGB, lgb_train, num_boost_round=<span style="color: #da8548; font-weight: bold;">2000</span>,
<span class="linenr">32: </span>                   valid_sets=lgb_eval, early_stopping_rounds=<span style="color: #da8548; font-weight: bold;">200</span>)
<span class="linenr">33: </span>
<span class="linenr">34: </span><span style="color: #dcaeea;">loglossTraining</span> = log_loss(y_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>], \
<span class="linenr">35: </span>    gbm.predict(X_train.loc[:<span style="color: #da8548; font-weight: bold;">4999</span>], num_iteration=gbm.best_iteration))
<span class="linenr">36: </span>trainingScore.append(loglossTraining)
<span class="linenr">37: </span>
<span class="linenr">38: </span>predictionsLightGBM.<span style="color: #dcaeea;">loc</span>[X_validation.<span style="color: #dcaeea;">index</span>,<span style="color: #dcaeea;">predictionColumns</span>] = \
<span class="linenr">39: </span>    gbm.predict(X_validation, num_iteration=gbm.best_iteration)
<span class="linenr">40: </span><span style="color: #dcaeea;">loglossValidation</span> = log_loss(y_validation,
<span class="linenr">41: </span>    predictionsLightGBM.loc[X_validation.index,predictionColumns])
<span class="linenr">42: </span>validationScore.append(loglossValidation)
<span class="linenr">43: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#26597;&#30475;&#23565;&#25976;&#25613;&#22833;&#20989;&#25976;&#21644;&#25972;&#39636;&#31934;&#30906;&#29575;</span>
<span class="linenr">44: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'Training Log Loss: '</span>, loglossTraining)
<span class="linenr">45: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'Validation Log Loss: '</span>, loglossValidation)
<span class="linenr">46: </span>
<span class="linenr">47: </span><span style="color: #dcaeea;">loglossLightGBM</span> = log_loss(y_validation, predictionsLightGBM)
<span class="linenr">48: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'LightGBM Gradient Boosting Log Loss: '</span>, loglossLightGBM)
<span class="linenr">49: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Supervised-only Accuracy</span>
<span class="linenr">50: </span><span style="color: #dcaeea;">predictionsLightGBM_firm</span> = np.argmax(np.array(predictionsLightGBM), axis=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">51: </span><span style="color: #dcaeea;">accuracyValidation_lightGBM</span> = accuracy_score(np.array(y_validation), \
<span class="linenr">52: </span>                                            predictionsLightGBM_firm)
<span class="linenr">53: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Supervised-Only Accuracy: "</span>, accuracyValidation_lightGBM)
</pre>
</div>

<pre class="example" id="org3974893">
/Users/letranger/opt/anaconda3/envs/python37/lib/python3.7/site-packages/lightgbm/engine.py:181: UserWarning: 'early_stopping_rounds' argument is deprecated and will be removed in a future release of LightGBM. Pass 'early_stopping()' callback via 'callbacks' argument instead.
  _log_warning("'early_stopping_rounds' argument is deprecated and will be removed in a future release of LightGBM. "
[1]	valid_0's multi_logloss: 1.8355
Training until validation scores don't improve for 200 rounds
[2]	valid_0's multi_logloss: 1.5523
...
[335]	valid_0's multi_logloss: 0.221976
Early stopping, best iteration is:
[135]	valid_0's multi_logloss: 0.192358
Training Log Loss:  0.0006489700296153399
Validation Log Loss:  0.19235843980200165
LightGBM Gradient Boosting Log Loss:  0.19235843980200165
Supervised-Only Accuracy:  0.9446
</pre>
</div>
</div>
<div id="outline-container-org24fb9b9" class="outline-4">
<h4 id="org24fb9b9"><span class="section-number-4">6.12.2.</span> 監督式與非監督式學習並用</h4>
<div class="outline-text-4" id="text-6-12-2">
<div class="org-src-container">
<pre class="src src-python"><span class="linenr"> 1: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Prepare DBN-based DataFrames for LightGBM use</span>
<span class="linenr"> 2: </span><span style="color: #dcaeea;">generatedImagesDF</span> = pd.DataFrame(data=generatedImages,index=<span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">100000</span>))
<span class="linenr"> 3: </span><span style="color: #dcaeea;">labelsDF</span> = pd.DataFrame(data=labels,index=<span style="color: #c678dd;">range</span>(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">100000</span>))
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span style="color: #dcaeea;">X_train_lgb</span> = pd.DataFrame(data=generatedImagesDF,
<span class="linenr"> 6: </span>                           index=generatedImagesDF.index)
<span class="linenr"> 7: </span><span style="color: #dcaeea;">X_validation_lgb</span> = pd.DataFrame(data=finalOutput_DBN_validation,
<span class="linenr"> 8: </span>                                index=X_validation.index)
<span class="linenr"> 9: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Train LightGBM</span>
<span class="linenr">10: </span><span style="color: #dcaeea;">trainingScore</span> = []
<span class="linenr">11: </span><span style="color: #dcaeea;">validationScore</span> = []
<span class="linenr">12: </span><span style="color: #dcaeea;">predictionsDBN</span> = pd.DataFrame(data=[],index=y_validation.index,
<span class="linenr">13: </span>                              columns=predictionColumns)
<span class="linenr">14: </span>
<span class="linenr">15: </span><span style="color: #dcaeea;">lgb_train</span> = lgb.Dataset(X_train_lgb, labels)
<span class="linenr">16: </span><span style="color: #dcaeea;">lgb_eval</span> = lgb.Dataset(X_validation_lgb, y_validation, reference=lgb_train)
<span class="linenr">17: </span><span style="color: #dcaeea;">gbm</span> = lgb.train(params_lightGB, lgb_train, num_boost_round=<span style="color: #da8548; font-weight: bold;">2000</span>,
<span class="linenr">18: </span>                   valid_sets=lgb_eval, early_stopping_rounds=<span style="color: #da8548; font-weight: bold;">200</span>)
<span class="linenr">19: </span>
<span class="linenr">20: </span><span style="color: #dcaeea;">loglossTraining</span> = log_loss(labelsDF, gbm.predict(X_train_lgb, \
<span class="linenr">21: </span>                            num_iteration=gbm.best_iteration))
<span class="linenr">22: </span>trainingScore.append(loglossTraining)
<span class="linenr">23: </span>
<span class="linenr">24: </span>predictionsDBN.<span style="color: #dcaeea;">loc</span>[X_validation.<span style="color: #dcaeea;">index</span>,<span style="color: #dcaeea;">predictionColumns</span>] = \
<span class="linenr">25: </span>    gbm.predict(X_validation_lgb, num_iteration=gbm.best_iteration)
<span class="linenr">26: </span><span style="color: #dcaeea;">loglossValidation</span> = log_loss(y_validation,
<span class="linenr">27: </span>    predictionsDBN.loc[X_validation.index,predictionColumns])
<span class="linenr">28: </span>validationScore.append(loglossValidation)
<span class="linenr">29: </span>
<span class="linenr">30: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'Training Log Loss: '</span>, loglossTraining)
<span class="linenr">31: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'Validation Log Loss: '</span>, loglossValidation)
<span class="linenr">32: </span>
<span class="linenr">33: </span><span style="color: #dcaeea;">loglossDBN</span> = log_loss(y_validation, predictionsDBN)
<span class="linenr">34: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">'LightGBM Gradient Boosting Log Loss: '</span>, loglossDBN)
<span class="linenr">35: </span><span style="color: #5B6268;"># </span><span style="color: #5B6268;">DBN-Based Solution Accuracy</span>
<span class="linenr">36: </span><span style="color: #dcaeea;">predictionsDBN_firm</span> = np.argmax(np.array(predictionsDBN), axis=<span style="color: #da8548; font-weight: bold;">1</span>)
<span class="linenr">37: </span><span style="color: #dcaeea;">accuracyValidation_DBN</span> = accuracy_score(np.array(y_validation), \
<span class="linenr">38: </span>                                        predictionsDBN_firm)
<span class="linenr">39: </span><span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"DBN-Based Solution Accuracy: "</span>, accuracyValidation_DBN)
</pre>
</div>

<pre class="example" id="org0172f82">
/Users/letranger/opt/anaconda3/envs/python37/lib/python3.7/site-packages/lightgbm/engine.py:181: UserWarning: 'early_stopping_rounds' argument is deprecated and will be removed in a future release of LightGBM. Pass 'early_stopping()' callback via 'callbacks' argument instead.
  _log_warning("'early_stopping_rounds' argument is deprecated and will be removed in a future release of LightGBM. "
[1]	valid_0's multi_logloss: 1.66314
Training until validation scores don't improve for 200 rounds
[2]	valid_0's multi_logloss: 1.35732
...
[260]	valid_0's multi_logloss: 0.226954
[261]	valid_0's multi_logloss: 0.227106
[262]	valid_0's multi_logloss: 0.227215
[263]	valid_0's multi_logloss: 0.227329
[264]	valid_0's multi_logloss: 0.227494
Early stopping, best iteration is:
[64]	valid_0's multi_logloss: 0.155201
Training Log Loss:  0.003464589940206874
Validation Log Loss:  0.15520095263526515
LightGBM Gradient Boosting Log Loss:  0.15520095263526515
DBN-Based Solution Accuracy:  0.9561
</pre>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Hands-On Machine Learning with Scikit-Learn: Aurelien Geron
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Yung-Chin Yen</p>
<p class="date">Created: 2023-12-05 Tue 13:37</p>
</div>
</body>
</html>